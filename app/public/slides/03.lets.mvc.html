<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Full-stack Development – Laravel course materials</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
    <link rel="stylesheet" href="main.css">
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <section data-background="#b5533c">
            <h3>Full-stack Development  [OGI03<span style="text-transform: none">r</span>]</h3>
            <h1>03. Let's MVC<br>with Eloquent</h1>
        </section>


        <!-- Laravel: what to expect -->
        <section>
            <section>
                <h2>03.1<br>Introducing MVC</h2>
            </section>


            <section>
                <h2>MVC</h2>
                <ul>
                    <li>
                        Short for <strong>Model-View-Controller</strong>
                    </li>
                    <li style="margin-top: 1em;">
                        Architectural pattern describing how to build your app
                    </li>
                    <li style="margin-top: 1em;">
                        In a web-context:
                        <ul>
                            <li>The model represents data</li>
                            <li>The view visually represents the model</li>
                            <li>The controller is the app logic: decides what the input was, and orchestrates the proper models/views</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        This presentation is about <strong>structuring</strong> our Laravel code into MVC
                    </li>
                </ul>
            </section>

            <section>
                <h2>Schematic</h2>
                <figure>
                    <img src="assets/02/mvc.png" alt="Model View Controller" title="Model View Controller" width="800" />
                    <figcaption>MVC Schematic <em>(<a href="http://www.dubberly.com/articles/model-view-controller-pattern.html">ref</a>)</em></figcaption>
                </figure>
            </section>
        </section>


        <section>
            <section>
                <h2>03.2<br>Introducing ORM</h2>
            </section>

            <section>
                <h2>ORM</h2>
                <ul>
                    <li>
                        Short for <strong>Object-Relational Mapping</strong>
                    </li>
                    <li style="margin-top: 1em;">
                        Connect data in the DB with objects in an object-oriented programming environment
                        <ul>
                            <li>Enables programming with a <em>virtual object database</em></li>
                            <li>Example: one entry (= row) of the table <code>customers</code> corresponds with one instance of the <code>Customer</code> class</li>
                            <li>Abstraction of SQL level results in less and clearer code</li>
                            <li>Typically implemented as a (part of a) library</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Active record pattern</h2>

                <ul>
                    <li>
                        <a href="https://en.wikipedia.org/wiki/Active_record_pattern">Active record pattern</a>
                        <ul>
                            <li>This means that an object instance is tied to a single row in the table</li>
                            <li>After creation of an object, a new row is added to the table upon save
                            </li>
                            <li>An update of the object results in a row update</li>
                            <li>The class has a property or getter method for each column</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Example</h2>
                <pre class="bigger"><code class="hljs php" data-overlay-example="assets/02/examples/simple-mvc/02.php">$todos = Todo::all();
print_r($todos);

echo $todos[0]->what;

$todo = new Todo();
$todo->what = 'Go lunching !!';
$todo->priority = 'high';
$todo->save();

print_r(Todo::all());
$todo->delete();
print_r(Todo::all());</code></pre>
                <ul style="font-size: 80%">
                    <li style="margin-top: 0.2em;">
                        How could this be implemented in plain PHP? &longrightarrow; let's have a look at
                        <ul>
                            <li><code>public/slides/assets/02/examples/simple-mvc/01.php</code> with a <code>Todo</code> class</li>
                            <li><code>public/slides/assets/02/examples/simple-mvc/02.php</code> with a generic <code>Model</code> class</li>
                            <li>Many features missing: dynamic PK, FKs, code safety and type checking, <code>WHERE</code>, <code>GROUP BY</code>, ...</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        Laravel's Eloquent ORM
                        <ul>
                            <li>implements all of these features</li>
                            <li>&hellip; but we'll first need to get acquainted with Query Builder</li>
                        </ul>
                    </li>
                </ul>
            </section>

        </section>

        <section>
            <section>
                <h2>03.3<br>Query Builder</h2>
            </section>

            <section>
                <h2>Query Builder (1)</h2>

                <ul>
                    <li>
                        Fluent interface for building SQL queries (<a href="https://laravel.com/docs/10.x/queries">docs</a>)
                        <ul>
                            <li>Always start with <code>DB::table()</code></li>
                            <li>and use chained methods to filter/select/aggregate data</li>
                            <li>Automatic prevention against <strong>SQL injection</strong></li>

                            <li style="margin-top: 0.5em">At the end of the chain: <code>get()</code> returning a <a href="https://laravel.com/docs/10.x/collections">Collection</a> of results
                                <pre class="bigger"><code class="hljs php" data-overlay-example="/types-demo?qb-1">$users = DB::table('users')-&gt;get();
dump($users);</code></pre>
                                <ul>
                                    <li>which you can still loop with <code>foreach</code></li>
                                    <li>where a result is an instance of PHP's base class having its columns accessible through properties</li>
                                </ul>
                                <pre class="bigger"><code class="hljs php">foreach ($users as $user) {
    echo $user-&gt;name;
}</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Query Builder (2)</h2>

                <ul>
                    <li>
                        Fluent interface for building SQL queries (<a href="https://laravel.com/docs/10.x/queries">docs</a>)
                        <ul>
                            <li>example with <code>select()</code>, <code>where()</code> and <code>groupBy()</code>
                                <pre class="bigger"><code class="hljs php">$users = DB::table('users')
                     -&gt;select('name', 'email as user_email')
                     -&gt;where('status', '&lt;&gt;', 1)
                     -&gt;groupBy('status')
                     -&gt;get();</code></pre>
                                <ul>
                                    <li><code>select()</code>, <code>where()</code>, <code>groupBy()</code> return a <a href="https://github.com/laravel/framework/blob/10.x/src/Illuminate/Database/Query/Builder.php">Builder</a> object
                                    <pre class="bigger"><code class="hljs php" data-overlay-example="/types-demo?qb-2">$where = DB::table('users')
    -&gt;select('name', 'email as user_email')
    -&gt;where('status', '<>', 1);
dump($where);</code></pre>
                                    </li>
                                    <li><code>get()</code> is the only method actually performing a query here !</li>
                                </ul>

                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Query Builder (3)</h2>

                <ul style="width: 100%;font-size: 85%;">
                    <li>
                        Methods running the database query
                        <ul>
                            <li><code>get()</code> returns a collection of all matching rows (as you already know)</li>
                            <li><code>first()</code> returns a single row
                                <pre class="bigger"><code class="hljs php">$user = DB::table('users')-&gt;where('name', 'John')-&gt;first();
echo $user-&gt;name;</code></pre>
                            </li>
                            <li><code>find()</code> retrieves a single row by the specified value for the <code>id</code> column
                                <pre class="bigger"><code class="hljs php">$user = DB::table('users')-&gt;find(3);</code></pre>
                            </li>
                            <li><code>value()</code> returns a single value
                                <pre class="bigger"><code class="hljs php">$email = DB::table('users')-&gt;where('name', 'John')-&gt;value('email');</code></pre>
                            </li>
                            <li><code>pluck()</code> returns a <strong>Collection</strong> of custom keys and <strong>values</strong>
                                <pre class="bigger"><code class="hljs php">$events = DB::table('event')-&gt;pluck('name', 'id');

foreach ($events as $id =&gt; $name) {
	&hellip;</code></pre>
                            </li>

                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Query Builder (4)</h2>

                <ul style="width: 100%;">
                    <li>
                        Chain a multitude of QB methods (<a href="https://laravel.com/docs/10.x/queries">docs</a>)
                        <ul>
                            <li>aggregate methods e.g. <code>count()</code>, <code>max()</code></li>
                            <li>much more e.g. <code>whereIn()</code>, <code>orWhere()</code>; joins e.g. <code>leftJoin()</code>, <code>on()</code>; offset and limit with <code>skip()</code> and <code>take()</code>; chunking results with <code>chunk()</code> </li>
                            <li>Examples with <code>insert()</code>, <code>update()</code> and <code>delete()</code>
                                <pre class="bigger"><code class="hljs php">$id = DB::table('users')->insertGetId(
    ['email' => 'john@example.com', 'votes' => 0]
);

DB::table('users')
            ->where('id', 1)
            ->update(['votes' => 1]);

DB::table('users')->increment('votes', 5);

DB::table('users')->where('votes', '&lt;', 100)->delete();

DB::table('flights')-&gt;upsert([
    ['departure' =&gt; 'Oakland', 'destination' =&gt; 'San Diego', 'price' =&gt; 99],
    ['departure' =&gt; 'Chicago', 'destination' =&gt; 'New York', 'price' =&gt; 150]
], ['departure', 'destination'], ['price']);
</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>
        </section>

        <section>
            <section>
                <h2>03.4<br>Eloquent ORM</h2>
            </section>

            <section>
                <h2>Defining the models (1)</h2>

                <ul>
                    <li>
                        ORM: &plusmn; each database table has a corresponding "Model" which is used to interact with (<a
                        href="https://laravel.com/docs/10.x/eloquent">Eloquent docs</a>)
                    </li>
                    <li>
                        First step: generate the models with Artisan <span class="warning">(! uppercase &amp; eng. singular)</span>
                        <pre class="bigger"><code class="hljs bash">$ php artisan make:model Event</code></pre>
                        <ul>
                            <li>It generates the (pretty empty) class <code>Event</code> extending <code>Illuminate\Database\Eloquent\Model</code> in the <code>app/Models/</code> directory</li>
                            <li>By now, the model assumes that there is a table <code>events</code> <span class="warning">(! lowercase &amp; eng. plural)</span> in the database
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Defining the models (2)</h2>

                <ul style="width: 80%;">
                    <li>
                        <code>app/Models/Event.php</code>
                        <pre class="bigger"><code class="hljs php">&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Event extends Model
{
    //
}</code></pre>
                    </li>

                </ul>
                <footer><small>Actually, it imports the <code>HasFactory</code> trait as well, just leave it there.</small></footer>
            </section>

            <section>
                <h2>Defining the models (3)</h2>

                <ul>
                    <li>
                        Next step: mark <em>unexpected table characteristics</em> in your model <code>app/Models/Event.php</code>
                        <ul>
                            <li>The model assumes that there is a table <code>events</code> (plural!) in the database, unless you add
                                <pre class="bigger"><code class="hljs php">protected $table = 'my_other_table_name';</code></pre>
                            </li>
                            <li>The model assumes the table has an (auto-increment) (integer) primary key called <code>id</code>, unless you add
                                <pre class="bigger"><code class="hljs php">protected $primaryKey = 'event_id';
public $incrementing = false;
protected $keyType = 'string';</code></pre>
                            </li>

                        </ul>
                    </li>
                </ul>

            </section>

            <section>
                <h2>Defining the models (4)</h2>

                <ul>
                    <li>
                        Next step: mark <em>unexpected table characteristics</em> in your model
                        <ul>
                            <li>The model assumes that the table has <code>created_at</code> and <code>updated_at</code> columns, unless you add
                                <pre class="bigger"><code class="hljs php">public $timestamps = false;</code></pre>
                                <ul>
                                    <li>Eloquent will automatically update these columns when creating/changing data</li>
                                    <li>Raw SQL Queries won't</li>
                                </ul>
                            </li>
                            <li>You don't need to add any information on the columns, but you can specify default column values if you want
                                <pre class="bigger"><code class="hljs php">protected $attributes = [
   'delayed' => false,
];</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
                <footer><small>Note: there are also settings on timestamp column names and formats</small></footer>
            </section>

            <section>
                <h2>Retrieving data</h2>

                <ul>
                    <li>
                        From now on, you can filter/select/aggregate data using the model
                        <ul>
                            <li>Eloquent's <code>all()</code> returns all records in the table
                                <pre class="bigger"><code class="hljs php">use App\Models\Event;

foreach (Event::all() as $event) {
    echo $event-&gt;name;
}</code></pre>
                            </li>
                            <li>Rely on <strong>Query Builder</strong> for many other (chained) methods
                                <pre class="bigger"><code class="hljs php">$events = Event::where('active', 1)
           -&gt;orderBy('name', 'desc')
           -&gt;take(10)
           -&gt;get();</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Find or fail</h2>

                <ul style="width: 100%;">
                    <li>
                        Retrieving single records with Eloquent's <code>find()</code> and <code>first()</code>
                        <pre class="bigger"><code class="hljs php">use App\Models\Event;

$event15 = Event::find(15); // retrieval by primary key
$activeEvent = Event::where('active', 1)->first(); // retrieve the first record
$activeEvent = Event::firstWhere('active', 1); // same</code></pre>
                        <ul>
                            <li>Throw a <code>ModelNotFoundException</code> when no result is found:
                                <pre class="bigger"><code class="hljs php">$event15 = Event::findOrFail(15);
$activeEvent = Event::where('active', 1)->firstOrFail();</code></pre>
                            </li>
                            <li>Results in a <code>404</code> HTTP response when not caught (!)</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>What does Eloquent return?</h2>
                    <ul>
                        <li>Actually, Eloquent methods like <code>all()</code> and <code>get()</code> return an <a href="https://laravel.com/docs/10.x/eloquent-collections">Eloquent Collection</a>
                            <pre class="bigger"><code class="hljs php" data-overlay-example="/types-demo?elo-1">use App\Models\Product;

$products = Product::all();
dump($products);</code></pre>
                            <ul style="font-size: 85%;">
                                <li><a href="https://laravel.com/docs/10.x/eloquent-collections">Eloquent Collections</a> inherit all capabilities from
                                    <a href="https://laravel.com/docs/10.x/collections">Collections</a>
                                    <br>e.g. <code>$products->count()</code>, <code>$products->pluck('name')</code>, <code>$products->where('name', 'Oneplus')</code>
                                    <br>but still <em>remember</em> their DB retrieval context (primary key, columns, etc.)
                                    <br>e.g. <code>$products->find(1)</code>
                                </li>
                            </ul>
                        </li>

                        <li style="margin-top: 1em;">Individual "row" results are <em>model instances</em>: objects of the model class (e.g. <code>class Product extends Model</code>) you generated with Artisan
                            <pre class="bigger"><code class="hljs php" data-overlay-example="/types-demo?elo-2">$product = Product::find(1);
dump($product);</code></pre>
                        </li>
                    </ul>
            </section>



            <section>
                <h2>Builder object or DB query result?</h2>
                        <ul style="font-size: 80%;width: 100%;">
                            <li style="margin-top: 0.5em;">
                                Static methods directly causing a DB query yielding a result
                                <pre class="bigger"><code class="hljs php">Event::all()          // returns an Eloquent collection of Event objects
Event::find(15)       // returns an Event object
Event::findOrFail(15) // returns an Event object
Event::count()        // returns an integer</code></pre>
                            </li>
                            <li style="margin-top: 0.5em;">
                                Static methods returning a Builder object (you are just building a query!)
                                <pre class="bigger"><code class="hljs php">Event::where('active', 1)
Event::select('id', 'name')</code></pre>
                            </li>
                            <li style="margin-top: 0.5em;">
                                Chaining of Builder methods, returning the <strong>very same</strong> Builder object
                                <pre class="bigger"><code class="hljs php">$events = Event::where('capacity', '>', 315)->where('active', 1)->select('id', 'name')->orderBy('capacity', 'desc');</code></pre>
                            </li>
                            <li style="margin-top: 0.5em;">
                                Methods transforming a Builder object into a result (executing a DB query)
                                <pre class="bigger"><code class="hljs php">$events->get()         // returns an Eloquent collection of Event objects
$events->count()       // returns an integer
$events->first()       // returns an Event object
$events->find(15)      // returns an Event object
$events->value('name') // returns a value
$events->pluck('name') // returns a plain old array</code></pre>
                            </li>

                        </ul>
            </section>

            <section>
                <h2>Active record</h2>

                <ul>
                    <li>
                        You can insert, update and delete rows correspondingly to the <a href="https://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>
                        <pre class="bigger"><code class="hljs php">use App\Models\Event;

$event = new Event;
$event-&gt;name = $request->name;
$event-&gt;save();

$event = Event::find(1);
$event-&gt;name = 'Pukkelpop 2024';
$event-&gt;save();

$event-&gt;delete();
</code></pre>
                        <ul>
                            <li>Note: alternately, you can do the same stuff with mass-assignment (see next) &hellip; - by the way Eloquent also enables deletion by PK:

                            </li>
                        </ul>
                        <pre class="bigger"><code class="hljs php">Event::destroy(7);</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Fresh, clean and dirty</h2>

                <ul style="width: 100%;font-size: 95%;">
                    <li>
                        <a href="https://laravel.com/docs/10.x/eloquent#refreshing-models">Refreshing</a> models
                        <pre class="bigger"><code class="hljs php">$event = Event::where('name', 'Pukkelpop 2024')-&gt;first();

$freshEvent = $event-&gt;fresh(); // reload from DB and create new Event object

$event-&gt;price = 280;
$event-&gt;refresh(); // reload from DB and "re-hydrate" existing Event object
$event-&gt;price; // 200</code></pre>
                    </li>
                    <li>
                        <a href="https://laravel.com/docs/10.x/eloquent#examining-attribute-changes">Examining attribute changes</a>
                        <pre class="bigger"><code class="hljs php">$event = Event::where('name', 'Pukkelpop 2024')-&gt;first();

$event-&gt;price = 280;
$event-&gt;isDirty(); // true
$event-&gt;isDirty('price'); // true
$event-&gt;isDirty('name'); // false
$event-&gt;isDirty(['price', 'name']); // true
$event-&gt;isClean('price'); // false

$event-&gt;save();

$event-&gt;isDirty(); // false
$event-&gt;isClean(); // true
</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Mass-assignment vulnerability (1)</h2>

                <ul>
                    <li>
                        Mass assignment
                        <ul style="font-size: 90%;">
                            <li>Definition: use a method that accepts a <span style="text-decoration: underline">list of column-value pairs</span> to create/edit a model instance
                                <pre class="bigger"><code class="hljs php">$user = User::create(['name' =&gt; 'Franky Pallemans', 'company' =&gt; 'Cynalco']); // does a DB INSERT</code></pre>
                            </li>
                            <li>It enables to pass all parameter/value-pairs of the HTTP request's querystring to the create method (think of &hellip; a registration form)
                                <pre class="bigger"><code class="hljs php">$user = User::create($request-&gt;all());</code></pre>
                            </li>
                            <li><strong>Mass-assignment vulnerability</strong>: a malicious user adds a parameter to the HTTP request e.g. <code>role=administrator</code> which is passed to the create method
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Mass-assignment vulnerability (2)</h2>

                <ul>
                    <li>
                        Mass assignment vulnerability protection
                        <ul style="font-size: 85%;">
                            <li style="margin-top: 0.5em;">It is required to
                                <ul>
                                    <li>blacklist: <code>protected $guarded = ['role'];</code>
                                    </li>
                                    <li>or whitelist: <code>protected $fillable = ['name', 'company'];</code> &rarr; <strong>our choice</strong>
                                    </li>
                                </ul>
                                the <em>&lsquo;mass assignable&rsquo;</em> attributes in the model class
                            </li>

                            <li style="margin-top: 0.5em;">Attention: when you pass a blacklisted/not-whitelisted parameter to a <em>&lsquo;vulnerable&rsquo;</em> method
                                <ul>
                                    <li>You don't get an error: Laravel just drops that parameter</code>
                                    </li>
                                </ul>
                            </li>
                            <li style="margin-top: 0.5em;">It only applies to vulnerable methods so you can still
                                <pre class="bigger"><code class="hljs php">$user-&gt;role = 'administrator';
$user-&gt;save();</code></pre>
                            </li>

                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>More mass-assignment methods</h2>

                <ul style="width: 100%;font-size: 80%;">
                    <li>
                        Model constructor with parameter
                        <pre class="bigger"><code class="hljs php">use App\Models\Event;

$event = new Event(['name' => 'Pukkelpop 2024']);</code></pre>
                    </li>
                    <li>
                        Apply <code>fill()</code> on a model instance
                        <pre class="bigger"><code class="hljs php">$event = new Event;
$event-&gt;fill(['name' => 'Pukkelpop 2024']);</code></pre>
                    </li>
                    <li>
                        Mass updates
                        <pre class="bigger"><code class="hljs php">Event::where('price', '>', 300)-&gt;update(['active' => 0]);</code></pre>
                    </li>
                    <li>
                        Conditional creation
                        <pre class="bigger"><code class="hljs php">// Retrieve the event by the attributes, or create it if it doesn't exist...
$event = Event::firstOrCreate(['name' => 'Dranouter 2021']);

// Retrieve the event by the attributes, or instantiate a new instance...
$event = Event::firstOrNew(['name' => 'Dranouter 2021']);
$event-&gt;save();

// If there's a matching event, set the price to $99.
// If no matching event exists, create one.
$event = Event::updateOrCreate(['name' => 'Dranouter 2021'], ['price' => 99]);

// Same for multiple rows? use Event::upsert()</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Eloquent relationships (1)</h2>

                <ul>
                    <li>
                        One-to-many example
                        <ul>
                            <li>Suppose a 1:n relation between <em>users</em> and <em>tasks</em> &rarr; table <em>tasks</em> has a foreign key column <code>user_id</code>
                            </li>
                            <li>Instead of working with FKs in Laravel, you want to interact with the related objects directly
                                <pre class="bigger"><code class="hljs php">$user = User::find(1);

foreach ($user-&gt;tasks as $task) {
    echo $task-&gt;name;
}
</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Eloquent relationships (2)</h2>

                <ul>
                    <li>
                        Bidirection support 1:n
                        <ul>

                            <li>Add to the <code>User</code> class: <span class="warning">(! plural)</span>
                                <pre class="bigger"><code class="hljs php">public function tasks(): HasMany
{
        return $this-&gt;hasMany(Task::class);
}
</code></pre>
                            </li>

                            <li>Add to the <code>Task</code> class: <span class="warning">(! singular)</span>
                                <pre class="bigger"><code class="hljs php">public function user(): BelongsTo
{
        return $this-&gt;belongsTo(User::class);
}
</code></pre>
                            </li>

                            <li>Read the <a href="https://laravel.com/docs/10.x/eloquent-relationships">docs on Eloquent relationships</a> to learn about other types of relationships
                            </li>
                        </ul>
                    </li>
                </ul>
                <footer><small><code>hasMany</code> and <code>belongsTo</code> have further options for non-default column names</small></footer>
            </section>

            <section>
                <h2>Eloquent relationships (3)</h2>

                <ul style="font-size: 85%;">
                    <li>
                        How to use these relationships?
                        <ul>

                            <li style="margin-top: 0.5em;">
                                <code>$user-&gt;tasks</code>
                                returns an <a
                                href="https://laravel.com/docs/10.x/eloquent-collections">Eloquent Collection</a> of Task objects (data)
                                <br>&rarr; <em>keep on chaining</em>
                            </li>
                            <li style="margin-top: 0.5em;">
                                <code>$user-&gt;tasks()</code>
                                returns a (Query) Builder object <br> &rarr; <em>keep on chaining</em> <br> &rarr; master relations with <a href="https://laravel.com/docs/10.x/eloquent-relationships#inserting-and-updating-related-models">create(), save() and associate()</a>
                            </li>

                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        &longrightarrow; Let's have a look at
                        <a href="https://laravel.com/docs/10.x/eloquent-relationships#many-to-many">many-to-many relationships</a> and
                        <a href="https://laravel.com/docs/10.x/eloquent-relationships#updating-many-to-many-relationships">how to update them</a>
                        <br>
                        remember: <span class="warning">never</span> make a separate model for the intermediate (= pivot) table

                    </li>
                </ul>

            </section>

            <section>
                <h2>Eloquent with dates and times</h2>

                <ul style="font-size: 85%;">
                    <li>
                        As you know, Laravel comes with <a href="http://carbon.nesbot.com/docs/">Carbon</a><pre class="bigger"><code class="hljs php">use Carbon\Carbon;</code></pre>
                        <ul>
                            <li>The Carbon class extends the PHP <a href="http://www.php.net/manual/en/class.datetime.php">DateTime</a> class
                            </li>
                            <li>You can use it as part of a query
                                <pre class="bigger"><code class="hljs php">$events = Event::where('event_date', '<', new Carbon('yesterday 23:10'))-&gt;get();
</code></pre>
                            </li>
                            <li>In order to have a Carbon object auto-casted at any time in Eloquent, you need to tell Eloquent first
                                <pre class="bigger"><code class="hljs php">class Event extends Model
{
    protected $casts = [
        'event_date' => 'datetime',
        // you don't need to mention created_at and updated_at here!
    ];
}
</code></pre>
                            </li>
                            <li>Now you can do things like <code>$event-&gt;event_date = Carbon::now();</code></li>
                            <li>Actually, with <code>$casts</code> you can define <a href="https://laravel.com/docs/10.x/eloquent-mutators#attribute-casting">many cast types</a> in order to have your attributes auto-converted</li>
                        </ul>
                    </li>
                </ul>
            </section>
        </section>




        <section>
            <section>
                <h2>03.5<br>MVC recap</h2>
            </section>

            <section>
                <h2>MVC in Laravel: overview</h2>
                <p><img src="assets/02/mvc_diagram_with_routes.png" alt="" title="" width="600" style="background-color:white;" />
                <div style="font-size: 50%; line-height: 100%;margin-top: -1em;">
                    Source: <a href="https://selftaughtcoders.com/from-idea-to-launch/lesson-17/laravel-5-mvc-application-in-10-minutes/">selftaughtcoders.com</a></span>
                </div>
            </section>

            <section>
                <h2>MVC in Laravel: overview</h2>
                <ul>
                    <li><strong>Models</strong>: generate Eloquent models with Artisan</li>
                    <li style="margin-top: 1em;"><strong>Views</strong>: store your Blade (or PHP) templates in <code>resources/views</code> </li>
                    <li style="margin-top: 1em;"><strong>Controllers</strong>: see next slide(s)</li>
                </ul>
            </section>
        </section>

        <section>
            <section data-background="https://i.makeagif.com/media/3-11-2016/SU3i02.gif">
                <h2>03.6<br>HTTP Controllers</h2>
                <p>This is the sound of C &hellip;</p>
            </section>

            <section>
                <h2>HTTP Controllers (1)</h2>

                <ul style="font-size: 80%; width: 80%;">
                    <li>Create a <code>*Controller</code> in the folder <code>app/Http/Controllers</code>
                        <pre class="bigger"><code class="hljs bash">php artisan make:controller TaskController</code></pre>
                    </li>
                    <li>
                        Point to its <strong>methods</strong> in <code>/routes/web.php</code> (or in <code>/routes/api.php</code>)
                        <pre class="bigger"><code class="hljs php">use App\Http\Controllers\TaskController;

Route::get('/tasks', [TaskController::class, 'index']);
Route::post('/tasks/create', [TaskController::class, 'store']);
Route::post('/tasks/{task}/delete', [TaskController::class, 'destroy'])-&gt;whereNumber('task');</code></pre>
                    </li>
                    <li>
                        Write the appropriate method(s) in <code>*Controller</code>
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    public function index(Request $request): View
    {
        $tasks = Task::where('user_id', $request-&gt;input('user_id'))
                    -&gt;orderBy('created_at', 'asc')
                    -&gt;get();
        return view('tasks.index', ['tasks' =&gt; $tasks]);
    }

    public function destroy(Request $request, string $id): RedirectResponse </code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>HTTP Controllers (2)</h2>

                <ul style="font-size: 80%; width: 80%;">
                    <li>
                        Only include the (type-hinted) $request parameter when needed
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    public function index(): View
    {
        return view('tasks.index');
    }</code></pre>
                    </li>
                    <li>
                        <a href="https://laravel.com/docs/10.x/routing#route-model-binding">Implicit model binding:</a> Eloquent will use the <code>id</code> column
                        <pre class="bigger"><code class="hljs php">Route::post('/tasks/{task}/delete', [TaskController::class, 'destroy']);</code></pre>
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    &hellip;
    // Task $task: implicit model binding (on ID) + 404 on fail
    public function destroy(Task $task): RedirectResponse
    {
        $task-&gt;delete();
        return redirect('/tasks');
    }</code></pre>
                    </li>
                </ul>
                <footer><small>Override the model's <code>getRouteKeyName()</code> in order to use another column for this</small></footer>

            </section>

            <section>
                <h2>Generating all classes together</h2>

                <ul style="width: 100%;">
                    <li>
                        Typical flow
                        <pre class="bigger"><code class="hljs bash"># start from an empty DB

# creates  model + create_products_table migration + ProductSeeder + ProductController
$ php artisan make:model Product -msc

# migration contains: $table-&gt;id();
# migration contains: $table-&gt;timestamps();
# add to your migration: other columns

$ php artisan migrate

# add data to your seeder

$ php artisan db:seed --class=ProductSeeder

# add to your model: mass-assignable blacklist/whitelist and dates/times

# use App\Models\Product wherever you want for your DB operations from your ProductController</code></pre>
                    </li>

                </ul>
                <footer><small>Note: Laravel comes with a pre-installed (extensible) migration and model for a <code>users</code> table </small></footer>
            </section>

            <!--section>
                <h2>Repositories (1)</h2>

                <ul>
                    <li>Repositories in Laravel
                        <ul>
                            <li style="margin-top: 1em;">Only useful for complex queries you'd call from multiple locations in your code (cf. code reuse)</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Repositories (2)</h2>

                <ul>
                    <li>Create the <code>app/Repositories</code> directory and add a <code>*Repository</code> class yourself
                        <pre class="bigger"><code class="hljs php">&lt;?php
namespace App\Repositories; // there is PSR-4 autoloading ...

use App\Task;

class TaskRepository
{
    public function forUserId($id)
    {
        return Task::where('user_id', $id)
                    -&gt;orderBy('created_at', 'asc')
                    -&gt;get();
    }
	&hellip;
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Repositories (3)</h2>

                <ul>
                    <li>
                        Inject the repository in the corresponding <code>*Controller</code>
                        <pre class="bigger"><code class="hljs php">namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Repositories\TaskRepository;

class TaskController extends Controller
{
    protected $tasks;

    public function __construct(TaskRepository $tasks)
    {
        $this-&gt;tasks = $tasks;
    }

    public function index(Request $request)
    {
        return view('tasks.index', [
            'tasks' =&gt; $this-&gt;tasks-&gt;forUserId($request-&gt;input('user_id'))
        ]);
    }
	&hellip;
}</code></pre>
                    </li>
                </ul>
            </section-->



        </section>

        <section>
            <section>
                <h2>03.7<br>Concluding demo</h2>
            </section>
            <section>
                <h2>Concluding demo</h2>
                <ul style="font-size: 85%;">
                    <li>Let's start from a DB schema for a webshop
                        <ul>
                            <li><strong>products</strong> (id&#128273;, name, description, price, <span style="color: red;">brand_id</span>)</li>
                            <li><strong>brands</strong> (id&#128273;, name)</li>
                            <li><strong>categories</strong> (id&#128273;, name)</li>
                            <li><strong>category_product</strong> (<span style="color: red;">category_id&#128273;</span>, <span style="color: red;">product_id&#128273;</span>)</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">Let's craft the migrations and seeders &longrightarrow;</li>
                    <li>Let's generate the Eloquent models including <code>$fillable</code> and all relationships &longrightarrow;</li>
                    <li>Let's try Eloquent in a simple ProductController &longrightarrow;</li>
                </ul>
            </section>
            <section>
                <h2>Eloquent demo (1)</h2>
                <pre class="bigger"><code class="hljs php" style="font-size: 85%" data-overlay-example="/eloquent-demo-1">    // retrieve product (data record) with ID 1
    $product = Product::find(1);
    dump($product->name);
    dump($product->price);

    // retrieve the product's brand (data record) through many-to-one
    $brand = $product->brand;
    dump('brand: ' . $brand->name);

    // retrieve the product's categories (collection of data records) through many-to-many
    $categories = $product->categories;
    foreach ($categories as $category) {
        dump('category: ' . $category->name);
    }

    // retrieve all products (collection of data records)
    $products = Product::all();
    dump('# products: ' . $products->count()); // count of collection
    dump('# products: ' . Product::count());   // count in DB query (faster!)</code></pre>
            </section>
            <section>
                <h2>Eloquent demo (2)</h2>
                <pre class="bigger"><code class="hljs php" style="font-size: 78%" data-overlay-example="/eloquent-demo-2">    // retrieve all products of brand 1
    $productsOfBrandOne = Product::where('brand_id', 1)->orderBy('price', 'desc')->get();
    dump('all products of brand 1 ---');
    dump($productsOfBrandOne->pluck('name', 'id')); // pluck of collection
    dump($productsOfBrandOne->pluck('name', 'id')->all()); // ... as a plain array
    dump(Product::where('brand_id', 1)->orderBy('price', 'desc')->pluck('name', 'id')); // pluck integrated in DB query


    // retrieve all products of category 2
    dump('all products of category 2 ---');
    $id = 2;
    dump(Category::find($id)->products->pluck('name')); // v1: involves 2 DB queries (key in collection is 0 !)
    dump(Category::find($id)->products()->pluck('name')); // v2: still 2 DB queries ...

    // v3: involves only 1 DB query
    $productsOfCategoryTwo = Product::whereHas('categories', function (Builder $query) use ($id) {
        $query->where('id', $id);
    })->get();
    dump($productsOfCategoryTwo);

    // v4: shorter, with whereRelation
    dump(Product::whereRelation('categories', 'id', $id)->get());</code></pre>
            </section>
            <section>
                <h2>Eloquent demo (3)</h2>
                <pre class="bigger"><code class="hljs php" style="font-size: 80%" data-overlay-example="/eloquent-demo-3">    // add a new product of brand 1
    $brand1 = Brand::find(1);
    $apple = new Product;
    $apple->name = 'Jonagold';
    $apple->description = 'Just a piece of fruit';
    $apple->price = 0.85;
    $apple->brand()->associate($brand1);
    $apple->save();

    // add another new product of brand 1 in one line
    $brand1->products()->create(['name' => 'Pink Lady', 'description' => 'Just a piece of fruit', 'price' => 0.85]);
    // yes ... you just saw a mass-assignment</code></pre>
            </section>
            <section>
                <h2>Eloquent demo (4)</h2>
                <pre class="bigger"><code class="hljs php" style="font-size: 85%" data-overlay-example="/eloquent-demo-4">    // product checkup: find products without category or price 0.00
    dump('faulty products ---');
    $faultyProductsBuilder = Product::where('price', 0.00)->orDoesntHave('categories');
    $faultyProductStrings = $faultyProductsBuilder->get()->map(function ($product) {
        return $product->id . '. ' . $product->name . ' (' . $product->price . '€)';
    });
    dump($faultyProductStrings->all());

    // Let's add both categories to the first faulty product
    $faultyProductsBuilder->first()?->categories()->sync([1, 2]); // ?-> null-safe operator

    // ... and delete all apples anyway
    Product::where('price', 0.85)->delete();</code></pre>
            </section>
        </section>

        <!-- The END -->
        <section>
            <section>
                <h2>Questions?</h2>
                <footer>
                    <em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:joris.maervoet@odisee.be">joris.maervoet@odisee.be</a></em>
                </footer>
            </section>

            <section>
                <h2>Sources</h2>


                <ul>
                    <li><a href="https://laravel.com/docs/10.x/queries">Laravel docs: Database: Query Builder</a></li>
                    <li><a href="https://laravel.com/docs/10.x/eloquent">Laravel docs: Eloquent: Getting Started</a></li>

                    <li><a href="https://laravel.com/docs/10.x/controllers">Laravel docs: Controllers</a></li>
                    <li><a href="https://laravel.com/docs/10.x/routing#route-model-binding">Laravel docs: Route Model Binding</a></li>

                </ul>
            </section>
        </section>


    </div>

</div>

<script src="dist/reveal.js"></script>
<script src="plugin/zoom/zoom.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/search/search.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>

    // Also available as an ES module, see:
    // https://revealjs.com/initialization/
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        slideNumber: true,


        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
    });

</script>
<script src="toc.js"></script>
<script src="overlay.js"></script>

</body>
</html>
