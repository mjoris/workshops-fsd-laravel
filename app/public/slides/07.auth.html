<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>W&amp;M Full-stack â€“ Laravel course materials</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
    <link rel="stylesheet" href="main.css">
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <section data-background="#b5533c">
            <h3>Web &amp; Mobile Full-Stack  [OGI03<span style="text-transform: none">r</span>]</h3>
            <h1>07. Auth</h1>
            <p><strong>Authentication</strong><br> verifying who a user is</p>
            <p>&amp;</p>
            <p><strong>Authorization</strong><br> verifying what a user has access to</p>
        </section>


        <!-- Form Requests -->
        <section>
            <section>
                <h2>07.1<br>Form Requests</h2>
            </section>

            <section>
                <h2>Form Request</h2>

                <ul>
                    <li>
                        Definition: custom class encapsulating validation and authorization logic
                    </li>
                    <li style="margin-top: 1.5em;">
                        Typically for 1 form
                    </li>
                    <li style="margin-top: 1.5em;">
                        It's called a request because <code>FormRequest extends Request</code>
                    </li>
                    <li style="margin-top: 1.5em;">
                        Objective: don't clutter your controller code with long and complex validation (example: fold-out form)
                    </li>


                </ul>
                <footer><small>The use of form requests is not obligatory in the project</small></footer>
            </section>
            <section>
                <h2>Creating a Form Request</h2>

                <ul style="width: 85%;">
                    <li>
                        How to create a <em>form request</em>?
                        <pre class="bigger"><code class="hljs bash">php artisan make:request StorePostRequest</code></pre>
                    </li>
                    <li style="margin-top: 0.7em;">
                        &longrightarrow; a <em>form request</em> class is created in <code>app/Http/Requests</code>
                        <pre class="bigger"><code class="hljs php" style="height: 22em;">class StorePostRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     *
     * @return bool
     */
    public function authorize()
    {
        return false;
    }

    /**
     * Get the validation rules that apply to the request.
     *
     * @return array
     */
    public function rules()
    {
        return [
            //
        ];
    }
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Specify rules()</h2>

                <ul style="width: 85%;">
                    <li>
                        Example
                        <pre class="bigger"><code class="hljs php">/**
 * Get the validation rules that apply to the request.
 *
 * @return array
 */
public function rules()
{
    return [
        'title' =&gt; 'required|unique:posts|max:255',
        'body' =&gt; 'required',
    ];
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Specify authorize()</h2>

                <ul style="width: 85%;">
                    <li>
                        Example
                        <pre class="bigger"><code class="hljs php">/**
 * Determine if the user is authorized to make this request.
 *
 * @return bool
 */
public function authorize()
{
    // assuming my 'users' table has an enum column 'role'
    return $this-&gt;user()-&gt;role == 'blogger';
}</code></pre>
                    </li>
                    <li>Most likely, you wil interact with your authorization <strong>gates</strong> and <strong>policies</strong> here &longrightarrow; we'll see this later on in this workshop</li>
                    <li>If you plan to put your authorization logic elsewhere, just write <code>return true;</code> </li>
                </ul>
            </section>

            <section>
                <h2>Applying the Form Request</h2>

                <ul style="width: 85%;">
                    <li>
                        Just type-hint the <em>form request</em> on your controller. Yes, that's all.
                        <pre class="bigger"><code class="hljs php">/**
 * Store a new blog post.
 *
 * @param  \App\Http\Requests\StorePostRequest  $request
 * @return Illuminate\Http\Response
 */
public function store(StorePostRequest $request)
{
    // The incoming request is valid and authorized ...
    Blogpost::create($request->all());
}</code></pre>
                    </li>
                    <li>You see? <code>FormRequest extends Request</code></li>
                    <li>When the <code>rules()</code> fail, the errors and input values are flashed into the session and the user is redirected </li>
                    <li>When the <code>authorize()</code> fails, a <code>403</code> page is shown </li>
                </ul>
            </section>

            <section>
                <h2>Further Customization</h2>

                <ul style="width: 85%;">
                    <li>Customizing <a href="https://laravel.com/docs/8.x/validation#customizing-the-error-messages"> the error messages and attribute names (!)</a></li>
                    <li><a href="https://laravel.com/docs/8.x/validation#preparing-input-for-validation">Preparing</a> the input for validation</li>
                </ul>
            </section>


        </section>

        <!-- Blade components -->
        <section>
            <section>
                <h2>07.2<br>Blade Components</h2>
            </section>

            <section>
                <h2>Blade Components</h2>

                <ul>
                    <li>
                        System similar to Blade sections, layouts and includes
                    </li>
                    <li style="margin-top: 1.5em;">
                        2 types of components: class based and anonymous
                    </li>
                    <li style="margin-top: 1.5em;">
                        A component is like a Blade subtemplate, and a class based component is also backed by a class
                    </li>
                </ul>
                <footer><small>The use of Blade components is not obligatory in the project</small></footer>
            </section>
            <section>
                <h2>Creating a Class Based Component</h2>

                <ul style="width: 85%;">
                    <li>
                        How to create a <em>class based component</em>?
                        <pre class="bigger"><code class="hljs bash">php artisan make:component Alert</code></pre>

                        &longrightarrow; creates a view template in <code>resources/views/components</code>
                        <br>
                        &longrightarrow; creates a component class in <code>app/View/Components</code>
                        <pre class="bigger"><code class="hljs php">class Alert extends Component
{
    public function __construct()
    {
        //
    }

    public function render()
    {
        return view('components.alert');
    }
}</code></pre>
                    </li>
                    <li>
                        Example with subdirectories:
                        <pre class="bigger"><code class="hljs bash">php artisan make:component Forms/Input</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Rendering components</h2>

                <ul style="width: 85%;font-size: 80%;">
                    <li>
                        Example
                        <pre class="bigger"><code class="hljs html">&lt;x-alert/&gt;
&lt;x-forms.input/&gt;</code></pre>
                    </li>
                    <li>
                        Passing data by HTML attributes (variable attributes start with <code>:</code>) &hellip;
                        <pre class="bigger"><code class="hljs html">&lt;x-alert type="error" :message="$message"/&gt;</code></pre>
                    </li>
                    <li>
                        &hellip; to be passed to the component's constructor:
                        <pre class="bigger"><code class="hljs php">class Alert extends Component
{
    public $type;
    public $message;

    public function __construct($type, $message)
    {
        $this-&gt;type = $type;
        $this-&gt;message = $message;
    }</code></pre>
                    </li>
                    <li>Public fields (/methods) are available in the component's view: <pre class="bigger"><code class="hljs html">&lt;div class="alert alert-{{ $type }}"&gt;
    {{ $message }}
&lt;/div&gt;</code></pre></li>
                </ul>
            </section>

            <section>
                <h2>Slots</h2>

                <ul style="width: 85%;">
                    <li>
                        Slots are the <em>sections</em> of a component
                    </li>
                    <li>
                        Let's say we have in <code>/resources/views/components/alert.blade.php</code>
                        <pre class="bigger"><code class="hljs html">&lt;span class="alert-title"&gt;{{ $title }}&lt;/span&gt;

&lt;div class="alert alert-danger"&gt;
    {{ $slot }}
&lt;/div&gt;</code></pre>
                    </li>
                    <li>
                        Injecting content into the component:
                        <pre class="bigger"><code class="hljs html">&lt;x-alert&gt;
    &lt;x-slot name="title"&gt;
        Server Error
    &lt;/x-slot&gt;

    &lt;strong&gt;Whoops!&lt;/strong&gt; Something went wrong!
&lt;/x-alert&gt;</code></pre></li>
                </ul>
            </section>

            <section>
                <h2>Blade Components: Interested?</h2>
                <ul>
                    <li>This was just a simple introduction. Read more in the <a
                        href="https://laravel.com/docs/8.x/blade#components">docs</a></li>
                </ul>
            </section>


        </section>

        <!-- Middleware -->
        <section>
            <section>
                <h2>07.3<br>Middleware</h2>

            </section>

            <section>
                <h2>Middleware Introduction</h2>

                <ul>
                    <li>
                        Middleware<small><a href="https://laravel.com/docs/8.x/middleware">&#9873;</a></small> = code executed before or after a request is handled by the application
                    </li>
                    <li style="margin-top: 1em;">
                        Middlewares can be global, or only for a specific route or controller
                        <ul>
                            <li>Application middleware</li>
                            <li>Route/controller specific middleware</li>
                        </ul>
                    </li>
                    <li>
                        Laravel offers pre-built middlewares located in the <code>app/Http/Middleware</code> directory e.g.
                        <ul>
                            <li>authentication</li>
                            <li>CSRF protection</li>
                            <li>&hellip;</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Defining your own Middleware</h2>

                <ul>
                    <li>
                        First step: generate the middleware with Artisan (location: <code>app/Http/Middleware</code>)
                        <pre class="bigger"><code class="hljs bash">$ php artisan make:middleware CheckAge</code></pre>
                    </li>
                    <li>
                        Example of <em>Before Middleware</em>
                        <pre class="bigger"><code class="hljs php">namespace App\Http\Middleware;
use Closure;

class CheckAge
{
    public function handle($request, Closure $next)
    {
        if ($request-&gt;age &lt;= 200) {
            return redirect('home');
        }
        return $next($request);
    }
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Before vs. After Middleware</h2>
                <pre class="bigger"><code class="hljs php">class BeforeMiddleware
{
    public function handle($request, Closure $next)
    {
        // Perform action

        return $next($request);
    }
}</code></pre>
                <pre class="bigger"><code class="hljs php">class AfterMiddleware
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        // Perform action

        return $response;
    }
}</code></pre>
            </section>


            <section>
                <h2>Registering Global Middleware</h2>

                <ul style="width: 100%;">
                    <li>
                        Add it to the <code>$middleware</code> property of your <code>app/Http/Kernel.php</code> class
                    </li>
                    <li style="margin-top: 1em;">
                        What's already in there?
                        <pre class="bigger"><code class="hljs php">    protected $middleware = [
        \App\Http\Middleware\TrustProxies::class,
        \Fruitcake\Cors\HandleCors::class,
        \App\Http\Middleware\PreventRequestsDuringMaintenance::class,
        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
        \App\Http\Middleware\TrimStrings::class,
        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
    ];</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (1)</h2>

                <ul>
                    <li>
                        <strong>Step 1:</strong> assign a short-hand key to the <code>$middleware</code> property of your <code>app/Http/Kernel.php</code> class
                    </li>
                    <li style="margin-top: 1em;">
                        What's already in there?
                        <pre class="bigger"><code class="hljs php">    protected $routeMiddleware = [
        'auth' =&gt; \App\Http\Middleware\Authenticate::class,
        'auth.basic' =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'cache.headers' =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::class,
        'can' =&gt; \Illuminate\Auth\Middleware\Authorize::class,
        'guest' =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,
        'password.confirm' =&gt; \Illuminate\Auth\Middleware\RequirePassword::class,
        'signed' =&gt; \Illuminate\Routing\Middleware\ValidateSignature::class,
        'throttle' =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,
        'verified' =&gt; \Illuminate\Auth\Middleware\EnsureEmailIsVerified::class,
    ];</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (2)</h2>

                <ul style="width: 100%;">
                    <li>
                        <strong>Step 2 option 1:</strong> plug the middleware to a specific route
                        <pre class="bigger"><code class="hljs php">Route::get('admin/profile', 'UserController@showProfile')-&gt;middleware('auth');</code></pre>
                        <pre class="bigger"><code class="hljs php">Route::get('/', function () {
    //
})-&gt;middleware(['first', 'second']);</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (3)</h2>

                <ul>
                    <li>
                        <strong>Step 2 option 2:</strong> plug the middleware <a href="https://laravel.com/docs/8.x/controllers#controller-middleware">to a specific controller</a>
                        <ul>
                            <li>Call the middleware from the controller's constructor</li>
                            <li>It is assigned to all actions in the controller</li>
                        </ul>
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    public function __construct()
    {
        $this-&gt;middleware('auth');

        $this-&gt;middleware('log')-&gt;only('index');

        $this-&gt;middleware('subscribed')-&gt;except('store');
    }
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (4)</h2>

                <ul>
                    <li>
                        <strong>Step 2 option 3:</strong> plug the middleware to a route group
                        <pre class="bigger"><code class="hljs php">Route::middleware(['first', 'second'])-&gt;group(function () {
    Route::get('/', function ()    {
        // Uses first and second Middleware
    });

    Route::get('user/profile', function () {
        // Uses first and second Middleware
    });
});</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Middleware Groups</h2>

                <ul>
                    <li>
                        Build groups of middleware in the <code>$middlewareGroups</code> property of your <code>app/Http/Kernel.php</code> class
                    </li>
                    <li style="margin-top: 1em;">
                        What's already in there?
                        <pre class="bigger"><code class="hljs php">protected $middlewareGroups = [
    'web' =&gt; [ // can be assigned to a route, a route group or a controller
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],</code></pre>
                    </li>
                    <li>The web middleware group is automatically applied to your <code>routes/web.php</code> file by the <code>RouteServiceProvider</code> !</li>
                </ul>
            </section>

            <section>
                <h2>Middleware Parameters</h2>

                <ul>

                    <li>
                        Check this interesting example (simple authorization)
                        <pre class="bigger"><code class="hljs php">namespace App\Http\Middleware;
use Closure;

class CheckRole
{
    public function handle($request, Closure $next, $role)
    {
        if (! $request->user()-&gt;hasRole($role)) {
            // Redirect...
        }
        return $next($request);
    }
}</code></pre>
                    </li>
                    <li>
                        Pass your parameters (separated by <code>,</code>) by adding a <code>:</code> after the middleware name
                        <pre class="bigger"><code class="hljs php">Route::post('blogposts/create', 'PostController@store')->middleware('role:editor');</code></pre>
                    </li>
                </ul>
            </section>


        </section>


        <!-- Authentication -->
        <section>
            <section>
                <h2>07.4<br>Authentication</h2>
                <p>= verifying who a user is</p>
                <p><small>For now, we'll focus on<br></small>  <strong>session</strong>-based authentication, <br><small>typically used in server-side rendered applications</small> </p>
            </section>


            <section>
                <h2>Authentication Introduction</h2>

                <ul>
                    <li>
                        Laravel's <a href="https://laravel.com/docs/8.x/authentication">Authentication</a>
                        <ul style="font-size: 85%;">
                            <li>
                                API containing basic authentication methods such as <code>Auth::login()</code>
                            </li>
                            <li>
                                To be configured in <code>config/auth.php</code>
                                <ul>
                                    <li><strong>Guards:</strong> how are users authenticated technically? e.g. session, token
                                    </li>
                                    <li><strong>Providers:</strong> where is the user information stored and how can it be retrieved? e.g. in the <code>users</code> table with Eloquent</li>
                                    <li>Resetting passwords</li>
                                </ul>
                            </li>

                        </ul>
                    </li>
                    <li style="margin-top: 1em;font-size: 85%;">
                        You <strong>could</strong> write your own authentication logic (controllers, views, routes) but might not be secure
                    </li>
                    <li style="margin-top: 1em;font-size: 85%;">
                        Starter Kits: packages <em>scaffolding</em> the entire authentication layer (controllers, views, routes)
                        <ul>
                            <li>
                                <a href="https://github.com/laravel/ui">Laravel UI</a> 3.x (considered as <em>obsolete</em>)
                            </li>
                            <li>
                                <a href="https://laravel.com/docs/8.x/starter-kits#laravel-breeze">Laravel Breeze</a> &longrightarrow; we'll use Breeze in the next slides
                            </li>
                            <li>
                                <a href="https://laravel.com/docs/8.x/fortify">Laravel Fortify</a> (front-end agnostic and encapsulated in a library)
                            </li>
                            <li>
                                <a href="https://jetstream.laravel.com/2.x/introduction.html">Laravel Jetstream</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>


            <section>
                <h2>Step 1: Migrations</h2>

                <ul>
                    <li>
                        <strong>Step 1:</strong> make sure you have the <code>users</code> and <code>password_resets</code> table in your database
                    </li>
                    <li style="margin-top: 0.5em;">
                        Use the preconfigured migrations (or copy and extend them)
                        <pre class="bigger"><code class="hljs php">Schema::create('users', function (Blueprint $table) {
    $table-&gt;id();
    $table-&gt;string('name');
    $table-&gt;string('email')->unique();
    $table-&gt;timestamp('email_verified_at')->nullable();
    $table-&gt;string('password');
    $table-&gt;rememberToken(); // can store the hash of a login cookie
    $table-&gt;timestamps();
});</code></pre>
                    </li>
                    <li>
                        <strong><u>Integrate</u></strong> this table in your DB design (add columns, FKs, &hellip;)
                    </li>
                </ul>
                <footer><small>Want to change the table names? Start with <code>config/auth.php</code></small></footer>
            </section>

            <section>
                <h2>Step 1B: Seeding</h2>

                <ul>
                    <li>
                        Optional: if you want to seed your database with 1 or more <strong><u>test</u></strong> users, tailor a <code>UserSeeder</code> to the users table's model
                        <pre class="bigger"><code class="hljs php">class UserSeeder extends Seeder
{

    public function run()
    {
        DB::table('users')-&gt;insert([
            'name' =&gt; Str::random(10),
            'email' =&gt; 'theboss@gmail.com',
            'password' =&gt; Hash::make('Azerty123'),
            // add more column values here e.g. a role, a company_id, ...
        ]);
    }

}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Step 2: Eloquent</h2>

                <ul>
                    <li>
                        <strong>Step 2:</strong> you will use Eloquent's preconfigured <code>User</code> model (<code>app/Models/User.php</code>)
                        <pre class="bigger"><code class="hljs php">class User extends Authenticatable
{
    // The attributes that are mass assignable.
    protected $fillable = [
        'name', 'email', 'password',
    ];

    // The attributes that should be hidden for arrays. (think of JSON serialization)
    protected $hidden = [
        'password', 'remember_token',
    ];

    // The attributes that should be cast to native types
    protected $casts = [
        'email_verified_at' =&gt; 'datetime',
    ];
}</code></pre>
                    </li>
                    <li style="margin-top: 1em;">
                        Extend this class if necessary (for example: Eloquent relationships)
                    </li>
                </ul>
            </section>

            <section>
                <h2>Step 3: Install Laravel Breeze</h2>
                <ul>
                    <li>
                        <strong>Step 3:</strong> install Breeze and make Artisan <em>scaffold</em> complete configuration for you
                        <p><span class="warning">Caution:</span> <code>routes/web.php</code> will be overwritten! </p>
                    </li>
                </ul>
                        <pre class="bigger"><code class="hljs bash">$ composer require laravel/breeze --dev

$ php artisan breeze:install
$ npm install
$ npm run dev
								</code></pre>
                <ul style="width: 100%;">
                    <li style="margin-top: 1em;">
                        By default, Breeze styles the templates with <a href="https://tailwindcss.com/">Tailwind CSS</a>.
                        <br>Want
                        <a href="https://inertiajs.com/">Inertia.js</a>? <code>php artisan breeze:install --inertia</code>
                    </li>
                    <li style="margin-top: 1em;">
                        What happened exactly? We'll cover this after the last step &hellip;
                    </li>
                </ul>
            </section>

            <section>
                <h2>Correction</h2>
                <h4>step 3 with Docker/WSL2 from Ubuntu for Windows</h4>
                <ul>
                    <li>
                        Unfortunately, npm has some bug when not executed as root user
                    </li>
                </ul>
                <pre class="bigger"><code class="hljs bash">$ docker compose exec -u 1000:1000 php-web bash
   # composer require laravel/breeze --dev
   # php artisan breeze:install
   # exit
$ docker compose exec php-web bash
   # mkdir /.npm
   # chown -R 1000:1000 "/.npm"
   # exit
$ docker compose exec -u 1000:1000 php-web bash
   # npm install
   # npm run dev
								</code></pre>

            </section>

            <section>
                <h2>Step 4: Redirect Paths</h2>

                <ul>
                    <li>
                        <strong>Step 4:</strong> set your redirect path (= destination after successful authentication)
                        <ul>
                            <li style="margin-top: 1em;">
                                In <code>app/Providers/RouteServiceProvider.php</code>:
                                <pre class="bigger"><code class="hljs php">public const HOME = '/tasks'; // '/dashboard' by default</code></pre>
                            </li>
                            <li  style="margin-top: 1em;">
                                and set your redirect path if unauthenticated in <code>app/Http/Middleware/Authenticate.php</code>
                                <pre class="bigger"><code class="hljs php">protected function redirectTo($request)
{
    if (! $request->expectsJson()) {
        return route('login');
    }
}</code></pre>
                            </li>
                        </ul>
                    </li>

                </ul>
                <footer><small>Note: these classes have nothing to do with Breeze - they're part of the Laravel core</small></footer>
            </section>

            <section>
                <h2>Step 5: Protecting Routes</h2>

                <ul>
                    <li>
                        <strong>Step 5:</strong> plug the <code>auth</code> middleware to each action requiring authentication
                        <ul>
                            <li style="margin-top: 1.5em;">
                                How? See the <a href="#/3/6">slides about middleware</a>
                            </li>
                        </ul>
                    </li>
                    <li style="margin-top: 1.5em;">
                        <strong>Step 5B:</strong> plug the <code>guest</code> middleware to each action requiring <strong>not</strong> being authenticated
                    </li>
                </ul>
            </section>
            <section>
                <h2>Coding with auth</h2>
                <ul style="width: 90%;">
                    <li>
                        Use the <code>Auth</code> facade in your code
                    </li>

                </ul>
                        <pre class="bigger"><code class="hljs php">use Illuminate\Support\Facades\Auth;

$user = Auth::user(); // retrieves the authenticated user
$tasks = Auth::user()->tasks; // oh yes! it's an Eloquent object!
$id = Auth::id(); // retrieves the currently authenticated user's ID

if (Auth::check()) {
    // the user is logged in...
    // you don't need to check this when the route is behind the auth middleware
}

Auth::logout();</code></pre>
                <ul style="width: 90%;">
                    <li style="margin-top: 0.3em;">
                        Blade's auth directives
                    </li>

                </ul>
                <pre class="bigger"><code class="hljs php">@auth
    // The user is authenticated...
@endauth

@guest
    // The user is not authenticated...
@endguest</code></pre>

            </section>

            <section>
                <h2>What the Hell Happened?</h2>

                <ul>
                    <li>
                        Laravel Breeze generated in your project: &longrightarrow; let's have a look
                        <ul style="font-size: 80%;">
                            <li>14 <a href="https://github.com/laravel/breeze/blob/1.x/stubs/default/routes/auth.php">routes</a> bundled into <code>routes/auth.php</code> included from a new(!) <code>routes/web.php</code></li>
                            <li>8 <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/App/Http/Controllers/Auth">controllers</a> for any of the HTML Forms e.g. <code>AuthenticatedSessionController</code> for login  </li>
                            <li>1 <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/App/Http/Requests/Auth">form request</a> </li>
                            <li>2 trivial <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/App/View/Components">Blade component classes</a></li>
                            <li>a large set of <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/resources/views">Blade templates</a></li>
                            <li>a <a href="https://laravel.com/docs/8.x/mix">Laravel Mix</a> (= a webpack wrapper) entrypoint <code>webpack.mix.js</code> for the compilation of js/css
                                <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/resources">resources</a> into the <code>public</code> folder</li>
                        </ul>
                    </li>

                    <li style="margin-top: 0.7em;">
                        <strong>You can change any of these</strong> as long as you know what you're doing
                    </li>
                </ul>
            </section>

            <section>
                <h2>Further Customization</h2>

                <ul>
                    <li>
                        Some examples
                        <ul style="font-size: 80%;">
                            <li>
                                Delete the routes of <code>routes/auth.php</code> you don't need &longleftarrow; is it okay that anybody can <strong>register</strong>?
                            </li>
                            <li style="margin-top: 0.7em;">
                                Login based on <code>username</code> in stead of <code>email</code>? Change it in <code>App/Http/Requests/Auth/LoginRequest</code>
                            </li>
                            <li style="margin-top: 0.7em;">
                                Having extra fields in the registration form? Add the validation/storage in <code>App/Http/Controllers/Auth/RegisteredUserController</code>
                            </li>
                            <li style="margin-top: 0.7em;">
                                No Tailwind in your web app? Remove the Blade templates/components and integrate the links and form elements in your lay-out
                            </li>
                        </ul>
                    </li>

                </ul>
            </section>

            <section>
                <h2>Further reading</h2>

                <ul>
                    <li>
                        Read the <a href="https://laravel.com/docs/8.x/authentication">Laravel docs on Authentication</a> on
                        <ul>
                            <li>
                                Authentication Throttling
                            </li>
                            <li>
                                Manually Authenticating Users
                            </li>
                            <li>
                                Resetting Passwords
                            </li>
                            <li>
                                Customizing guards and providers
                            </li>
                            <li>Social authentication with <a href="https://laravel.com/docs/8.x/socialite">Laravel Socialite</a></li>
                        </ul>
                    </li>

                </ul>
            </section>

        </section>

        <!-- Authorization -->
        <section>
            <section>
                <h2>07.5<br>Authorization</h2>
                <p>= verifying what a user has access to</p>
            </section>



            <section>
                <h2>Authorization Introduction</h2>

                <ul>
                    <li>
                        Laravel's <a href="https://laravel.com/docs/8.x/authorization">Authorization</a>
                        <ul style="font-size: 85%;">
                            <li>
                                Principle: <strong>once</strong> a user is authenticated, allow or prevent user <strong>actions</strong> against a given <strong>resource</strong>
                            </li>

                            <li>
                                Most commonly, it is about <u>C</u>reating, <u>R</u>eading, <u>U</u>pdating or <u>D</u>eleting a specific Eloquent model
                                <ul>
                                    <li>a user might (not) be entitled to do so because
                                        <ul>
                                            <li>(s)he has a certain <strong>role</strong> (e.g. admin, customer)</li>
                                            <li>(s)he is (not) the <strong>owner</strong> of the resource</li>
                                        </ul>
                                </ul>
                            </li>
                            <li>With Laravel's <a href="https://laravel.com/docs/8.x/authorization">Authorization</a>, you can check this in a <strong>structured</strong> way</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        2 mechanisms
                        <ul style="font-size: 85%;">
                            <li><strong>Gates:</strong> simple mechanism where you express an authorization feature as a function
                            </li>
                            <li><strong>Policies:</strong> group all authorization logic by resource</li>
                            <li>It's fine to mix them</li>
                        </ul>
                    </li>
                </ul>
            </section>


            <section>
                <h2>Gates: Definition</h2>

                <ul>
                    <li>
                        To be defined in <code>boot()</code> of <code>App\Providers\AuthServiceProvider</code>
                    </li>
                    <li>
                        First parameter <strong>must</strong> be of type <code>User</code> (will be bound to the Eloquent model of the authenticated user)
                        <pre class="bigger"><code class="hljs php">use App\Models\Post;
use App\Models\User;
use Illuminate\Support\Facades\Gate;

public function boot()
{
    $this-&gt;registerPolicies();

    Gate::define('update-post', function (User $user, Post $post) {
        return $user-&gt;id === $post-&gt;user_id;
    });
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Authorizing with Gates</h2>

                <ul style="font-size: 85%;">
                    <li>
                        At the start of your controller method:
                        <pre class="bigger"><code class="hljs php">if (! Gate::allows('update-post', $post)) {
    abort(403);
}

// Update the post...</code></pre>
                    </li>
                    <li>
                        Same, shorter version:
                        <pre class="bigger"><code class="hljs php">Gate::authorize('update-post', $post);
// Update the post...</code></pre>
                    </li>
                    <li>Alternately, if you are in a <strong>form request</strong>, <code>authorize()</code> will automatically generate <code>403</code> when it fails
                        <pre class="bigger"><code class="hljs php">public function authorize()
{
    return Gate::allows('update-post', $post);
}</code></pre>
                    </li>
                    <li>Check single permissions with <code>Gate::allows()</code> and <code>Gate::denies()</code></li>
                    <li>Check combinations of permissions with <code>Gate::check()</code>, <code>Gate::any()</code> and <code>Gate::none()</code> </li>
                    <li>Check for other users with <code>Gate::forUser($user)</code></li>
                </ul>
            </section>


            <section>
                <h2>Creating a Policy</h2>

                <ul style="font-size: 85%; width: 90%;">
                    <li>Example: you want to write the authorization logic for your <code>App\Models\Product</code> model</li>
                    <li style="margin-top: 0.7em;">
                        <strong>First step:</strong> create an empty policy class
                        <pre class="bigger"><code class="hljs bash">php artisan make:policy ProductPolicy --model=Product</code></pre>
                        The option <code>--model</code> adds example methods related to viewing, creating, updating, and deleting a <code>Product</code>
                    </li>
                    <li style="margin-top: 0.7em;">
                        &longrightarrow; the  class is created in <code>app/Policies</code>
                    </li>
                    <li style="margin-top: 0.7em;">

                        <strong>Registering the policy?</strong>
                        <ul>
                            <li><u>Not needed</u>, as the policy class name = <code>model class name</code> + <code>Policy</code> (auto-discovery) </li>
                            <li>If you have another naming convention, you can register the policy in <code>App\Providers\AuthServiceProvider</code></li>
                        </ul>
                        <pre class="bigger"><code class="hljs php">class AuthServiceProvider extends ServiceProvider
{
    // The policy mappings for the application.
    protected $policies = [
        Product::class =&gt; ProductPolicy::class,
    ];</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Writing a Policy</h2>

                <pre class="bigger"><code class="hljs php" style="font-size: 85%;line-height: 1.2;">&lt;?php
namespace App\Policies;

use App\Models\Product;
use App\Models\User;

class ProductPolicy
{
    /**
     * Determine if the given product can be updated by the user.
     *
     * @param  \App\Models\User  $user
     * @param  \App\Models\Product  $post
     * @return bool
     */
    public function update(User $user, Product $product)
    {
        return $user-&gt;id === $product-&gt;user_id;
    }

    /**
     * Determine if the given user can create products.
     *
     * @param  \App\Models\User  $user
     * @return bool
     */
    public function create(User $user)
    {
        return $user-&gt;role == 'admin';
    }
}</code></pre>
            </section>

            <section>
                <h2>Authorizing with Policies (1)</h2>

                <ul style="font-size: 80%;">
                    <li>
                        You will use <code>can()</code> and <code>cannot()</code>
                        <br>
                        <strong>Important:</strong> if no policy method found, they look for a <strong><u>gate</u></strong>
                    </li>
                    <li style="margin-top: 0.7em;">
                        At the start of your controller method:
                        <pre class="bigger"><code class="hljs php">if ($request-&gt;user()-&gt;cannot('update', $product)) { // Auth::user() is fine too ;-)
    abort(403);
}
// Update the product...</code></pre>
                    </li>
                    <li>
                        Same, shorter version:
                        <pre class="bigger"><code class="hljs php">$this-&gt;authorize('update', $product);
// Update the product...</code></pre>
                    </li>
                    <li>Alternately, if you are in a <strong>form request</strong>, <code>authorize()</code> will automatically generate <code>403</code> when it fails
                        <pre class="bigger"><code class="hljs php">public function authorize()
{
    $product = Product::find($this->product_id); // given product_id is an input value of the Request
    return $this->user()->can('update', $product);
}</code></pre>
                    </li>
                    <li>
                        For actions that don't require model instances, you specify the class:
                        <br>
                        <code>if ($request-&gt;user()-&gt;cannot('create', Product::class))</code>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Authorizing with Policies (2)</h2>
                <ul style="width: 70%;">
                    <li>
                        Better: authorize via the <code>can</code> middleware &#128512;
                        <pre class="bigger"><code class="hljs php">use App\Models\Product;

Route::put('/product/{product}', function (Product $product) {
    // The current user may update the product...
})-&gt;middleware('can:update,product');

Route::post('/product', function () {
    // The current user may create products...
})-&gt;middleware('can:create,App\Models\Product');</code></pre>
                    </li>

                </ul>
            </section>



            <section>
                <h2>Blade's @can and @cannot</h2>
                <ul style="width: 85%;">
                    <li>
                        Work for both gates and policies:
                        <pre class="bigger"><code class="hljs html">@can('update', $post)
    &lt;!-- The current user can update the post... --&gt;
@elsecan('create', App\Models\Post::class)
    &lt;!-- The current user can create new posts... --&gt;
@else
    &lt;!-- ... --&gt;
@endcan

@cannot('update', $post)
    &lt;!-- The current user cannot update the post... --&gt;
@elsecannot('create', App\Models\Post::class)
    &lt;!-- The current user can now create new posts... --&gt;
@endcannot</code></pre>
                    </li>

                </ul>
            </section>




        </section>

        <section>
            <section>
                <h2>07.6<br>Demo</h2>
            </section>
            <section data-background="#fdfdfd">
                <h2>Demo outline</h2>
                <ul style="font-size: 85%;">
                    <li>Remember the webshop demo pages <code>/products</code>, <code>/products/{id}</code> and <code>/products/create</code> ?</li>

                    <li>&longrightarrow; Let's integrate the users table into the model and extend the users with roles (customer or admin)</li>
                </ul>
                <img src="assets/05/demo-auth-model.png" alt="" width="750">
                <ul style="font-size: 85%;width: 100%;">
                    <li>&longrightarrow; Let's protect <code>/products/create</code> from unauthenticated &amp; unauthorized (= customer) users</li>
                    <li>&longrightarrow; Let's have a look at the code &hellip;</li>
                </ul>
            </section>
        </section>

        <section>
            <section>
                <h2>07.7<br>Web API Authentication</h2>
                <p><strong>Token</strong>-based authentication</p>
            </section>

            <section>
                <h2>Laravel Passport and Laravel Sanctum</h2>

                <ul>
                    <li>
                        <strong>Laravel Passport</strong> the official <a href="https://laravel.com/docs/8.x/passport">library</a> implementing pseudo-authentication with OAuth 2.0, the industry-standard protocol
                    </li>
                    <li style="margin-top: 1em;">
                        <strong>Laravel Sanctum</strong>: the official <em>lightweight</em> Web API Authentication library
                    </li>
                    <li style="margin-top: 1em;">
                        Sanctum supports 2 types of authentication
                        <ul style="font-size: 85%;">
                            <li>
                                <strong>API Token Authentication</strong>: your application can issue API tokens, having a very long expiration time, to end users (typically developers). When a 3rd party application makes a request to your Web API, the token should be included in the <code>Authorization</code> header
                            </li>
                            <li style="margin-top: 1em;">
                                <strong>SPA Authentication</strong>: your SPA is in a trusted domain and can send requests in order to authenticate individual users. Actually, Sanctum &plusmn; falls back to the <em>stateful</em> authentication (with session cookies) you already know.
                                <br>
                                &longrightarrow; we'll only talk about this type
                            </li>



                        </ul>
                    </li>

                </ul>
            </section>

            <section>
                <h2>Installation Recipe</h2>

                <ul style="font-size: 85%;width: 85%;">
                    <li>
                        As described in the <a href="https://laravel.com/docs/8.x/sanctum#spa-authentication">Sanctum docs</a>:
                        <ul>
                            <li><pre class="bigger"><code class="hljs bash">composer require laravel/sanctum</code></pre></li>
                            <li><pre class="bigger"><code class="hljs bash">php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"</code></pre></li>
                            <li>(migration is only required for API Token Authentication)</li>
                            <li>add Sanctum's middleware to the <code>api</code> middleware group in <code>app/Http/Kernel.php</code>


                                <pre class="bigger"><code class="hljs php">'api' =&gt; [
    \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
    'throttle:api',
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
],</code></pre>
                            </li>
                            <li>open <code>config/sanctum.php</code> and make sure that your <code>domain:port</code> combination is in <code>SANCTUM_STATEFUL_DOMAINS</code>. This setting determines for which domains authentication cookies are set.
                                <br><strong>Attention:</strong> <code>localhost:8080</code> is not the same as <code>127.0.0.1:8080</code>
                            </li>

                        </ul>

                    </li>
                </ul>

            </section>

            <section>
                <h2>Routes Recipe (1)</h2>

                <ul style="font-size: 85%;width: 90%;">
                    <li>
                        The route <code>GET /sanctum/csrf-cookie</code> hands out CSRF tokens as it sets an <code>XSRF-TOKEN</code> cookie
                        <ul>
                            <li>You must pass this cookie in an <code>X-XSRF-TOKEN</code> header(!) of subsequent requests</li>
                            <li>Some JavaScript libraries do this automatically for you</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        You should implement your login route yourself in <code>routes/web.php</code> (!!!)
                        <ul>
                            <li>
                                For example, <code>POST /api/login</code>
                                <pre class="bigger"><code class="hljs php">Route::post('/api/login', function (Request $request) {
    $credentials = $request-&gt;only('email', 'password');
    if (Auth::attempt($credentials)) {
        return response(['message' =&gt; 'The user has been authenticated successfully'], 200);
    }
    return response(['message' =&gt; 'The provided credentials do not match our records.'], 401);

});</code></pre>
                            </li>
                            <li>Unfortunately, Breeze's login route is not compatible as it redirects after login even if the request only accepts JSON</li>
                            <li>As the <em>normal</em> <code>web</code> mechanisms apply here, after successful login the user receives a session cookie <code>myapplicationname_session</code>, of which the server remembers there is successful authentication and by whom</li>
                        </ul>
                    </li>

                </ul>

            </section>

            <section>
                <h2>Routes Recipe (2)</h2>

                <ul style="font-size: 85%;width: 90%;">
                    <li>
                        Protect the Web API routes in <code>routes/api.php</code> by plugging the <code>auth:sanctum</code> middleware:
                        <pre class="bigger"><code class="hljs php">Route::middleware('auth:sanctum')-&gt;get('/secret1', function (Request $request) {
    return $request-&gt;user();
});</code></pre>
                        <ul>
                            <li>Actually, Sanctum is just applying the <em>normal</em> <code>web</code> and <code>auth</code> middlewares here</li>
                            <li>So, if the user includes the right session cookie <code>myapplicationname_session</code>, the user is authenticated in the route</li>
                            <li>Some JavaScript libraries do this automatically for you</li>
                            <li>Needs a <code>Referer</code> header (!!!)</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        You could implement your logout route yourself in <code>routes/web.php</code> (!!!)
                        <ul>
                            <li>
                                For example, <code>POST /api/logout</code>
                                <pre class="bigger"><code class="hljs php">Route::post('/api/logout', function (Request $request) {
    Auth::guard('web')-&gt;logout();
    $request-&gt;session()-&gt;invalidate();
    return response(['message' =&gt; 'The user has been logged out successfully'], 200);
});</code></pre>
                            </li>

                        </ul>
                    </li>

                </ul>

            </section>
            <section data-background="#fdfdfd">
                <h2>Demo with Insomnia or Postman</h2>
                <figure class="zoomable-20">
                    <img src="assets/05/sanctum1.png" alt="Sanctum example 1" height="140">
                </figure>
                <figure class="zoomable-20">
                    <img src="assets/05/sanctum2.png" alt="Sanctum example 2" height="140">
                </figure>
                <figure class="zoomable-20">
                    <img src="assets/05/sanctum3.png" alt="Sanctum example 3" height="140">
                </figure>
                <footer><small>demo with Postman on <a
                    href="https://blog.codecourse.com/laravel-sanctum-airlock-with-postman/">codecourse</a></small></footer>
            </section>


            <section>
                <h2>Example</h2>

                <ul style="font-size: 85%;width: 90%;">
                    <li>
                        Use authentication and authorization as you were used to:
                        <pre class="bigger"><code class="hljs php">Route::post('/v4/products', function (Request $request) {

    Gate::authorize('add-product');

    $request-&gt;validate([
        'name' =&gt; 'required|unique:products|max:125',
        'price' =&gt; 'required|numeric|min:0.10',
        'description' =&gt; 'required',
        'brand_id' =&gt; 'required|exists:brands,id'
    ]);

    $product = new Product($request-&gt;all());
    $product-&gt;user()-&gt;associate(Auth::user());
    $product-&gt;save();

    return ['message' =&gt; 'The product has been created'];

})-&gt;middleware('auth:sanctum');</code></pre>

                    </li>

                </ul>

            </section>

            <section>
                <h2>Full example: laravel-tasks-api</h2>
                <p><a href="https://gitlab.com/ikdoeict/joris.maervoet/laravel-tasks-api">https://gitlab.com/ikdoeict/joris.maervoet/laravel-tasks-api</a></p>
            </section>


        </section>







        <!-- The END -->
        <section>
            <section>
                <h2>Questions?</h2>
                <footer>
                    <em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:joris.maervoet@odisee.be">joris.maervoet@odisee.be</a></em>
                </footer>
            </section>
            <section>
                <h2>Sources</h2>
                <ul>
                    <li><a href="https://laravel.com/docs/8.x/middleware">Laravel docs: Middleware</a></li>
                    <li><a href="https://laravel.com/docs/8.x/authentication">Laravel docs: Authentication</a></li>

                </ul>
            </section>
        </section>


    </div>

</div>

<script src="dist/reveal.js"></script>
<script src="plugin/zoom/zoom.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/search/search.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>

    // Also available as an ES module, see:
    // https://revealjs.com/initialization/
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        slideNumber: true,


        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
    });


</script>
<script src="toc.js"></script>
<script src="overlay.js"></script>

</body>
</html>
