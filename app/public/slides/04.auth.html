<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>W&amp;M Full-stack â€“ Laravel course materials</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
    <link rel="stylesheet" href="main.css">
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <section data-background="#b5533c">
            <h3>Web &amp; Mobile Full-Stack  [OGI03<span style="text-transform: none">r</span>]</h3>
            <h1>04. Auth</h1>
            <p><strong>Authentication</strong><br> verifying who a user is</p>
            <p>&amp;</p>
            <p><strong>Authorization</strong><br> verifying what a user has access to</p>
        </section>


        <!-- Form Requests -->
        <section>
            <section>
                <h2>04.1<br>Form Requests</h2>
            </section>


        </section>

        <!-- Blade components -->
        <section>
            <section>
                <h2>04.2<br>Blade Components</h2>
            </section>


        </section>

        <!-- Middleware -->
        <section>
            <section>
                <h2>04.3<br>Middleware</h2>

            </section>

            <section>
                <h2>Middleware Introduction</h2>

                <ul>
                    <li>
                        Middleware<small><a href="https://laravel.com/docs/8.x/middleware">&#9873;</a></small> = code executed before or after a request is handled by the application
                    </li>
                    <li style="margin-top: 1em;">
                        Middlewares can be global, or only for a specific route or controller
                        <ul>
                            <li>Application middleware</li>
                            <li>Route/controller specific middleware</li>
                        </ul>
                    </li>
                    <li>
                        Laravel offers pre-built middlewares located in the <code>app/Http/Middleware</code> directory e.g.
                        <ul>
                            <li>authentication</li>
                            <li>CSRF protection</li>
                            <li>&hellip;</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Defining your own Middleware</h2>

                <ul>
                    <li>
                        First step: generate the middleware with Artisan (location: <code>app/Http/Middleware</code>)
                        <pre class="bigger"><code class="hljs bash">$ php artisan make:middleware CheckAge</code></pre>
                    </li>
                    <li>
                        Example of <em>Before Middleware</em>
                        <pre class="bigger"><code class="hljs php">namespace App\Http\Middleware;
use Closure;

class CheckAge
{
    public function handle($request, Closure $next)
    {
        if ($request-&gt;age &lt;= 200) {
            return redirect('home');
        }
        return $next($request);
    }
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Before vs. After Middleware</h2>
                <pre class="bigger"><code class="hljs php">class BeforeMiddleware
{
    public function handle($request, Closure $next)
    {
        // Perform action

        return $next($request);
    }
}</code></pre>
                <pre class="bigger"><code class="hljs php">class AfterMiddleware
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        // Perform action

        return $response;
    }
}</code></pre>
            </section>


            <section>
                <h2>Registering Global Middleware</h2>

                <ul style="width: 100%;">
                    <li>
                        Add it to the <code>$middleware</code> property of your <code>app/Http/Kernel.php</code> class
                    </li>
                    <li style="margin-top: 1em;">
                        What's already in there?
                        <pre class="bigger"><code class="hljs php">    protected $middleware = [
        \App\Http\Middleware\TrustProxies::class,
        \Fruitcake\Cors\HandleCors::class,
        \App\Http\Middleware\PreventRequestsDuringMaintenance::class,
        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
        \App\Http\Middleware\TrimStrings::class,
        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
    ];</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (1)</h2>

                <ul>
                    <li>
                        <strong>Step 1:</strong> assign a short-hand key to the <code>$middleware</code> property of your <code>app/Http/Kernel.php</code> class
                    </li>
                    <li style="margin-top: 1em;">
                        What's already in there?
                        <pre class="bigger"><code class="hljs php">    protected $routeMiddleware = [
        'auth' =&gt; \App\Http\Middleware\Authenticate::class,
        'auth.basic' =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'cache.headers' =&gt; \Illuminate\Http\Middleware\SetCacheHeaders::class,
        'can' =&gt; \Illuminate\Auth\Middleware\Authorize::class,
        'guest' =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,
        'password.confirm' =&gt; \Illuminate\Auth\Middleware\RequirePassword::class,
        'signed' =&gt; \Illuminate\Routing\Middleware\ValidateSignature::class,
        'throttle' =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,
        'verified' =&gt; \Illuminate\Auth\Middleware\EnsureEmailIsVerified::class,
    ];</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (2)</h2>

                <ul style="width: 100%;">
                    <li>
                        <strong>Step 2 option 1:</strong> plug the middleware to a specific route
                        <pre class="bigger"><code class="hljs php">Route::get('admin/profile', 'UserController@showProfile')-&gt;middleware('auth');</code></pre>
                        <pre class="bigger"><code class="hljs php">Route::get('/', function () {
    //
})-&gt;middleware(['first', 'second']);</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (3)</h2>

                <ul>
                    <li>
                        <strong>Step 2 option 2:</strong> plug the middleware <a href="https://laravel.com/docs/8.x/controllers#controller-middleware">to a specific controller</a>
                        <ul>
                            <li>Call the middleware from the controller's constructor</li>
                            <li>It is assigned to all actions in the controller</li>
                        </ul>
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    public function __construct()
    {
        $this-&gt;middleware('auth');

        $this-&gt;middleware('log')-&gt;only('index');

        $this-&gt;middleware('subscribed')-&gt;except('store');
    }
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Registering specific middleware (4)</h2>

                <ul>
                    <li>
                        <strong>Step 2 option 3:</strong> plug the middleware to a route group
                        <pre class="bigger"><code class="hljs php">Route::middleware(['first', 'second'])-&gt;group(function () {
    Route::get('/', function ()    {
        // Uses first and second Middleware
    });

    Route::get('user/profile', function () {
        // Uses first and second Middleware
    });
});</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Middleware Groups</h2>

                <ul>
                    <li>
                        Build groups of middleware in the <code>$middlewareGroups</code> property of your <code>app/Http/Kernel.php</code> class
                    </li>
                    <li style="margin-top: 1em;">
                        What's already in there?
                        <pre class="bigger"><code class="hljs php">protected $middlewareGroups = [
    'web' =&gt; [ // can be assigned to a route, a route group or a controller
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],</code></pre>
                    </li>
                    <li>The web middleware group is automatically applied to your <code>routes/web.php</code> file by the <code>RouteServiceProvider</code> !</li>
                </ul>
            </section>

            <section>
                <h2>Middleware Parameters</h2>

                <ul>

                    <li>
                        Check this interesting example (simple authorization)
                        <pre class="bigger"><code class="hljs php">namespace App\Http\Middleware;
use Closure;

class CheckRole
{
    public function handle($request, Closure $next, $role)
    {
        if (! $request->user()-&gt;hasRole($role)) {
            // Redirect...
        }
        return $next($request);
    }
}</code></pre>
                    </li>
                    <li>
                        Pass your parameters (separated by <code>,</code>) by adding a <code>:</code> after the middleware name
                        <pre class="bigger"><code class="hljs php">Route::post('blogposts/create', 'PostController@store')->middleware('role:editor');</code></pre>
                    </li>
                </ul>
            </section>


        </section>


        <!-- Authentication -->
        <section>
            <section>
                <h2>04.5<br>Authentication</h2>

            </section>


            <section>
                <h2>Authentication Introduction</h2>

                <ul>
                    <li>
                        Laravel's <a href="https://laravel.com/docs/8.x/authentication">Authentication</a>
                        <ul style="font-size: 85%;">
                            <li>
                                API containing basic authentication methods such as <code>Auth::login()</code>
                            </li>
                            <li>
                                Starter Kits: packages <em>scaffolding</em> the entire authentication layer (controllers, views, routes, &hellip;)
                                <ul>
                                    <li>
                                        <a href="https://laravel.com/docs/8.x/starter-kits#laravel-breeze">Laravel Breeze</a> &longrightarrow; we'll use Breeze in the next slides
                                    </li>
                                    <li>
                                        <a href="https://laravel.com/docs/8.x/fortify">Laravel Fortify</a>
                                    </li>
                                    <li>
                                        <a href="https://jetstream.laravel.com/2.x/introduction.html">Laravel Jetstream</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        Configuration
                        <ul style="font-size: 85%;">
                            <li><strong>Guards:</strong> how are users authenticated technically? e.g. session, token
                            </li>
                            <li><strong>Providers:</strong> where is the user information stored and how can it be retrieved? e.g. in the <code>users</code> table with Eloquent</li>
                            <li>Resetting passwords</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        These components can be configured in <code>config/auth.php</code>
                    </li>
                </ul>
            </section>


            <section>
                <h2>Step 1: Migrations</h2>

                <ul>
                    <li>
                        <strong>Step 1:</strong> make sure you have the <code>users</code> and <code>password_resets</code> table in your database
                    </li>
                    <li style="margin-top: 0.5em;">
                        Use the preconfigured migrations (or copy and extend them)
                        <pre class="bigger"><code class="hljs php">Schema::create('users', function (Blueprint $table) {
    $table-&gt;id();
    $table-&gt;string('name');
    $table-&gt;string('email')->unique();
    $table-&gt;timestamp('email_verified_at')->nullable();
    $table-&gt;string('password');
    $table-&gt;rememberToken(); // can store the hash of a login cookie
    $table-&gt;timestamps();
});</code></pre>
                    </li>
                    <li>
                        <strong><u>Integrate</u></strong> this table in your DB design (add columns, FKs, &hellip;)
                    </li>
                </ul>
                <footer><small>Want to change the table names? Start with <code>config/auth.php</code></small></footer>
            </section>

            <section>
                <h2>Step 1B: Seeding</h2>

                <ul>
                    <li>
                        Optional: if you want to seed your database with 1 or more <strong><u>test</u></strong> users, tailor a <code>UserSeeder</code> to the users table's model
                        <pre class="bigger"><code class="hljs php">class UserSeeder extends Seeder
{

    public function run()
    {
        DB::table('users')-&gt;insert([
            'name' =&gt; Str::random(10),
            'email' =&gt; 'theboss@gmail.com',
            'password' =&gt; Hash::make('Azerty123'),
            // add more column values here e.g. a role, a company_id, ...
        ]);
    }

}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Step 2: Eloquent</h2>

                <ul>
                    <li>
                        <strong>Step 2:</strong> you will use Eloquent's preconfigured <code>User</code> model (<code>app/Models/User.php</code>)
                        <pre class="bigger"><code class="hljs php">class User extends Authenticatable
{
    // The attributes that are mass assignable.
    protected $fillable = [
        'name', 'email', 'password',
    ];

    // The attributes that should be hidden for arrays. (think of JSON serialization)
    protected $hidden = [
        'password', 'remember_token',
    ];

    // The attributes that should be cast to native types
    protected $casts = [
        'email_verified_at' =&gt; 'datetime',
    ];
}</code></pre>
                    </li>
                    <li style="margin-top: 1em;">
                        Extend this class if necessary (for example: Eloquent relationships)
                    </li>
                </ul>
            </section>

            <section>
                <h2>Step 3: Install Laravel Breeze</h2>

                <ul>
                    <li>
                        <strong>Step 3:</strong> install Breeze and make Artisan <em>scaffold</em> complete configuration for you
                    </li>
                </ul>
                        <pre class="bigger"><code class="hljs bash">$ composer require laravel/breeze --dev

$ php artisan breeze:install
$ npm install
$ npm run dev
								</code></pre>
                <ul style="width: 100%;">
                    <li style="margin-top: 1em;">
                        By default, Breeze styles the templates with <a href="https://tailwindcss.com/">Tailwind CSS</a>.
                        <br>Want
                        <a href="https://inertiajs.com/">Inertia.js</a>? <code>php artisan breeze:install --inertia</code>
                    </li>
                    <li style="margin-top: 1em;">
                        What happened exactly? We'll cover this after the last step &hellip;
                    </li>
                </ul>
            </section>

            <section>
                <h2>Step 4: Redirect Paths</h2>

                <ul>
                    <li>
                        <strong>Step 4:</strong> set your redirect path (= destination after successful authentication)
                        <ul>
                            <li style="margin-top: 1em;">
                                In <code>app/Http/Providers/RouteServiceProvider.php</code>:
                                <pre class="bigger"><code class="hljs php">public const HOME = '/tasks'; // '/home' by default</code></pre>
                            </li>
                            <li  style="margin-top: 1em;">
                                and set your redirect path if unauthenticated in <code>app/Http/Middleware/Authenticate.php</code>
                                <pre class="bigger"><code class="hljs php">protected function redirectTo($request)
{
    if (! $request->expectsJson()) {
        return route('login');
    }
}</code></pre>
                            </li>
                        </ul>
                    </li>

                </ul>
                <footer><small>Note: these classes have nothing to do with Breeze - they're part of the Authentication API</small></footer>
            </section>

            <section>
                <h2>Step 5: Protecting Routes</h2>

                <ul>
                    <li>
                        <strong>Step 5:</strong> plug the <code>auth</code> middleware to each action requiring authentication
                        <ul>
                            <li style="margin-top: 1.5em;">
                                How? See the <a href="#/3/6">slides about middleware</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>
            <section>
                <h2>Coding with auth</h2>
                <ul style="width: 90%;">
                    <li>
                        Use the <code>Auth</code> facade in your code
                    </li>

                </ul>
                        <pre class="bigger"><code class="hljs php">use Illuminate\Support\Facades\Auth;

$user = Auth::user(); // retrieves the authenticated user
$tasks = Auth::user()->tasks; // oh yes! it's an Eloquent object!
$id = Auth::id(); // retrieves the currently authenticated user's ID

if (Auth::check()) {
    // the user is logged in...
    // you don't need to check this when the route is behind the auth middleware
}

Auth::logout();</code></pre>
                <ul style="width: 90%;">
                    <li style="margin-top: 0.3em;">
                        Blade's auth directives
                    </li>

                </ul>
                <pre class="bigger"><code class="hljs php">@auth
    // The user is authenticated...
@endauth

@guest
    // The user is not authenticated...
@endguest</code></pre>

            </section>

            <section>
                <h2>What the Hell Happened?</h2>

                <ul>
                    <li>
                        Laravel Breeze generated in your project: &longrightarrow; let's have a look
                        <ul style="font-size: 80%;">
                            <li>14 <a href="https://github.com/laravel/breeze/blob/1.x/stubs/default/routes/auth.php">routes</a> bundled into <code>routes/auth.php</code> to be included from <code>routes/web.php</code></li>
                            <li>8 <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/App/Http/Controllers/Auth">controllers</a> for any of the HTML Forms e.g. <code>AuthenticatedSessionController</code> for login  </li>
                            <li>1 <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/App/Http/Requests/Auth">form request</a> </li>
                            <li>2 trivial <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/App/View/Components">Blade component classes</a></li>
                            <li>a large set of <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/resources/views">Blade templates</a></li>
                            <li>a <a href="https://laravel.com/docs/8.x/mix">Laravel Mix</a> (= a webpack wrapper) entrypoint <code>webpack.mix.js</code> for the compilation of js/css
                                <a href="https://github.com/laravel/breeze/tree/1.x/stubs/default/resources">resources</a> into the <code>public</code> folder</li>
                        </ul>
                    </li>

                    <li style="margin-top: 0.7em;">
                        <strong>You can change any of these</strong> as long as you know what you're doing
                    </li>
                </ul>
            </section>

            <section>
                <h2>Further Customization</h2>

                <ul>
                    <li>
                        Some examples
                        <ul style="font-size: 80%;">
                            <li>
                                Delete the routes of <code>routes/auth.php</code> you don't need &longleftarrow; is it okay that anybody can <strong>register</strong>?
                            </li>
                            <li style="margin-top: 0.7em;">
                                Login based on <code>username</code> in stead of <code>email</code>? Change it in <code>App/Http/Requests/Auth/LoginRequest</code>
                            </li>
                            <li style="margin-top: 0.7em;">
                                Having extra fields in the registration form? Add the validation/storage in <code>App/Http/Controllers/Auth/RegisteredUserController</code>
                            </li>
                            <li style="margin-top: 0.7em;">
                                No Tailwind in your web app? Remove the Blade templates/components and integrate the links and form elements in your lay-out
                            </li>
                        </ul>
                    </li>

                </ul>
            </section>

            <section>
                <h2>Further reading</h2>

                <ul>
                    <li>
                        Read the <a href="https://laravel.com/docs/8.x/authentication">Laravel docs on Authentication</a> on
                        <ul>
                            <li>
                                Authentication Throttling
                            </li>
                            <li>
                                Manually Authenticating Users
                            </li>
                            <li>
                                Resetting Passwords
                            </li>
                            <li>
                                Customizing guards and providers
                            </li>
                            <li>Social authentication with <a href="https://laravel.com/docs/8.x/socialite">Laravel Socialite</a></li>
                        </ul>
                    </li>

                </ul>
            </section>

        </section>

        <!-- Authorization -->
        <section>
            <section>
                <h2>04.6<br>Authorization</h2>

            </section>
        </section>







        <!-- The END -->
        <section>
            <section>
                <h2>Questions?</h2>
                <footer>
                    <em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:joris.maervoet@odisee.be">joris.maervoet@odisee.be</a></em>
                </footer>
            </section>
            <section>
                <h2>Sources</h2>
                <ul>
                    <li><a href="https://laravel.com/docs/8.x/middleware">Laravel docs: Middleware</a></li>
                    <li><a href="https://laravel.com/docs/8.x/authentication">Laravel docs: Authentication</a></li>

                </ul>
            </section>
        </section>


    </div>

</div>

<script src="dist/reveal.js"></script>
<script src="plugin/zoom/zoom.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/search/search.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>

    // Also available as an ES module, see:
    // https://revealjs.com/initialization/
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        slideNumber: true,


        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
    });


</script>
<script src="toc.js"></script>
<script src="overlay.js"></script>

</body>
</html>
