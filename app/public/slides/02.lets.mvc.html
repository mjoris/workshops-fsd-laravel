<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>W&amp;M Full-stack â€“ Laravel course materials</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">
    <link rel="stylesheet" href="main.css">
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <section data-background="#b5533c">
            <h3>Web &amp; Mobile Full-Stack  [OGI03<span style="text-transform: none">r</span>]</h3>
            <h1>02. Let's MVC</h1>
        </section>


        <!-- Laravel: what to expect -->
        <section>
            <section>
                <h2>02.1<br>Introducing MVC</h2>
            </section>


            <section>
                <h2>MVC</h2>
                <ul>
                    <li>
                        Short for <strong>Model-View-Controller</strong>
                    </li>
                    <li style="margin-top: 1em;">
                        Architectural pattern describing how to build your app
                    </li>
                    <li style="margin-top: 1em;">
                        In a web-context:
                        <ul>
                            <li>The model represents data</li>
                            <li>The view visually represents the model</li>
                            <li>The controller is the app logic: decides what the input was, and orchestrates the proper models/views</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        This presentation is about <strong>structuring</strong> our Laravel code into MVC
                    </li>
                </ul>
            </section>

            <section>
                <h2>Schematic</h2>
                <figure>
                    <img src="assets/02/mvc.png" alt="Model View Controller" title="Model View Controller" width="800" />
                    <figcaption>MVC Schematic <em>(<a href="http://www.dubberly.com/articles/model-view-controller-pattern.html">ref</a>)</em></figcaption>
                </figure>
            </section>
        </section>


        <section>
            <section>
                <h2>02.2<br>Introducing ORM</h2>
            </section>

            <section>
                <h2>ORM</h2>
                <ul>
                    <li>
                        Short for <strong>Object-Relational Mapping</strong>
                    </li>
                    <li style="margin-top: 1em;">
                        Connect data in the DB with objects in an object-oriented programming environment
                        <ul>
                            <li>Enables programming with a <em>virtual object database</em></li>
                            <li>Example: one entry (= row) of the table <code>customers</code> corresponds with one instance of the <code>Customer</code> class</li>
                            <li>Abstraction of SQL level results in less and clearer code</li>
                            <li>Typically implemented as a (part of a) library</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Active record pattern</h2>

                <ul>
                    <li>
                        <a href="https://en.wikipedia.org/wiki/Active_record_pattern">Active record pattern</a>
                        <ul>
                            <li>This means that an object instance is tied to a single row in the table</li>
                            <li>After creation of an object, a new row is added to the table upon save
                            </li>
                            <li>An update of the object results in a row update</li>
                            <li>The class has a property or getter method for each column</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Plain PHP example v1 (part 1)</h2>

                <ul style="font-size: 85%; width: 100%;">
                    <li>
                        Assume a DB table <code>todos</code> with columns <code>id</code> (PK), <code>what</code> and <code>priority</code>
                        <pre class="bigger"><code class="hljs php" style="font-size: 85%">class Todo {

    private $id = 0; // 0 means: not stored in DB
    public $what;
    public $priority;

    public function __construct($assocArray = []) {
        $this->id = array_key_exists('id', $assocArray)? $assocArray['id'] : 0;
        $this->what = array_key_exists('what', $assocArray)? $assocArray['what'] : '';
        $this->priority = array_key_exists('priority', $assocArray)? $assocArray['priority'] : 'low';
    }

    &hellip;</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Plain PHP example v1 (part 2)</h2>
                <pre class="bigger"><code class="hljs php" style="font-size: 85%">    public function save() {
        if ($this->id === 0) {
            $stmt = Database::getDatabase()->prepare('INSERT INTO todos (what, priority) VALUES (?, ?);');
            $stmt->execute(array($this->what, $this->priority ));
            $this->id = Database::getDatabase()->lastInsertId();
        } else {
            $stmt = Database::getDatabase()->prepare('UPDATE todos SET what = ?, priority = ? WHERE id = ?;');
            $stmt->execute(array($this->what, $this->priority, $this->id ));
        }
    }

    public static function all() {
        $todoObjects = [];
        $stmt = Database::getDatabase()->query('SELECT * FROM todos;');
        while ($todo = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $todoObjects[] = new Todo($todo);
        }
        return $todoObjects;
    }
}</code></pre>

            </section>

            <section>
                <h2>Plain PHP example v1 (part 3)</h2>

                <ul style="font-size: 85%">
                    <li>
                        Demo usage
                        <pre class="bigger"><code class="hljs php" data-overlay-example="assets/02/examples/simple-mvc/01.php">$todos = Todo::all();
print_r($todos);

echo $todos[0]->what;

$todo = new Todo();
$todo->what = 'Go lunching !!';
$todo->priority = 'high';
$todo->save();

print_r(Todo::all());
$todo->delete();
print_r(Todo::all());</code></pre>
                    </li>
                    <li style="margin-top: 1em;">
                        Not too bad but ...
                        <ul>
                            <li>this version cannot be used as a library yet: the full ORM code needs to be generated or written, even when a column is added</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Plain PHP example v2 (part 1)</h2>

                <pre class="bigger"><code class="hljs php" style="font-size: 85%">class Model { // let's make a version of Todo that does not depend on the data model ...

    private $assocArray = []; // 'id' => 0 means: not stored in DB

    public function __get($key) { // magic method for inaccessible properties '->'
        return $this->assocArray[$key];
    }

    public function __set($key, $value) { // magic method for inaccessible properties '->'
        $this->assocArray[$key] = $value;
    }

    protected static function getTablename() {
        return strtolower(get_called_class()) . 's'; // needs some linguistic optimization
    }

    public function __construct($assocArray = []) {
        if (!array_key_exists('id', $assocArray)) {
            $assocArray['id'] = 0;
        }
        $this->assocArray = $assocArray;
    }
    &hellip;</code></pre>
            </section>

            <section>
                <h2>Plain PHP example v2 (part 2)</h2>
                <pre class="bigger"><code class="hljs php" style="font-size: 85%">    public function save() {
        $assocWithoutId = array_diff_key($this->assocArray, array('id' => 'dummy'));
        if ($this->id === 0) {
            $stmt = Database::getDatabase()->prepare('INSERT INTO ' . self::getTablename() . ' (' .
                implode(',', array_keys($assocWithoutId)) . ') VALUES (' .
                substr(str_repeat("?,", count($assocWithoutId)), 0, -1) . ');');
            $stmt->execute(array_values($assocWithoutId));
            $this->id = Database::getDatabase()->lastInsertId();
        } else {
            $stmt = Database::getDatabase()->prepare('UPDATE ' . self::getTablename() . ' SET ' .
                implode(' = ?,', array_keys($assocWithoutId)) . ' = ? WHERE id = ?;');
            $stmt->execute(array_values($this->assocArray));
        }
    }

    public static function all() {
        $todoObjects = [];
        $stmt = Database::getDatabase()->query('SELECT * FROM ' . self::getTablename() . ';');
        while ($todo = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $subclassName = get_called_class();
            $todoObjects[] = new $subclassName($todo);
        }
        return $todoObjects;
    }
}</code></pre>

            </section>

            <section>
                <h2>Plain PHP example v2 (part 3)</h2>

                <ul style="font-size: 85%">
                    <li>
                        Demo usage
                        <pre class="bigger"><code class="hljs php" data-overlay-example="assets/02/examples/simple-mvc/02.php">class Todo extends Model {
    // override getTablename() if you need to
}

$todos = Todo::all();
print_r($todos);

echo $todos[0]->what;

$todo = new Todo();
$todo->what = 'Go lunching !!';
$todo->priority = 'high';
$todo->save();

print_r(Todo::all());
$todo->delete();
print_r(Todo::all());</code></pre>
                    </li>
                    <li style="margin-top: 0.2em;">
                        That's better
                        <ul>
                            <li>ORM implementation details hidden in the Model class and very few work to plug your own data model</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Plain PHP example v2: epilogue</h2>

                <ul style="font-size: 85%">
                    <li>
                        Of course this example is far from complete &hellip;
                        <ul>
                            <li>Eliminate <code>id</code> as the required PK column name &rarr; see v3</li>
                            <li>Robustness: code safety and type checking</li>
                            <li>Support for <code>WHERE</code>, <code>GROUP BY</code>, <code>ORDER BY</code>, &hellip;</li>
                            <li>Foreign key support</li>
                        </ul>
                    </li>
                    <li style="margin-top: 1em;">
                        Laravel's Eloquent ORM
                        <ul>
                            <li>implements all of these features</li>
                            <li>&hellip; but we'll first need to get acquainted with Query Builder</li>
                        </ul>
                    </li>
                </ul>
            </section>

        </section>

        <section>
            <section>
                <h2>02.3<br>Query Builder</h2>
            </section>

            <section>
                <h2>Query Builder (1)</h2>

                <ul>
                    <li>
                        Fluent interface for building SQL queries (<a href="https://laravel.com/docs/8.x/queries">docs</a>)
                        <ul>
                            <li>Always start with <code>DB::table()</code></li>
                            <li>and use chained methods to filter/select/aggregate data</li>
                            <li>Automatic prevention against <strong>SQL injection</strong></li>

                            <li style="margin-top: 0.5em">At the end of the chain: <code>get()</code> returning a <a href="https://laravel.com/docs/8.x/collections">Collection</a> of results
                                <pre class="bigger"><code class="hljs php">$users = DB::table('users')-&gt;get();</code></pre>
                                <ul>
                                    <li>which you can still loop with <code>foreach</code></li>
                                    <li>where a result is an instance of PHP's base class having its columns accessible through properties</li>
                                </ul>
                                <pre class="bigger"><code class="hljs php">foreach ($users as $user) {
    echo $user-&gt;name;
}</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Query Builder (2)</h2>

                <ul>
                    <li>
                        Fluent interface for building SQL queries (<a href="https://laravel.com/docs/8.x/queries">docs</a>)
                        <ul>
                            <li>example with <code>select()</code>, <code>where()</code> and <code>groupBy()</code>
                                <pre class="bigger"><code class="hljs php">$users = DB::table('users')
                     -&gt;select('name', 'email as user_email')
                     -&gt;where('status', '&lt;&gt;', 1)
                     -&gt;groupBy('status')
                     -&gt;get();</code></pre>
                                <ul>
                                    <li><code>select()</code>, <code>where()</code>, <code>groupBy()</code> return a <a href="https://github.com/laravel/framework/blob/8.x/src/Illuminate/Database/Query/Builder.php">Builder</a> object</li>
                                    <li><code>get()</code> is the only method actually performing a query here !</li>
                                </ul>

                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Query Builder (3)</h2>

                <ul style="width: 100%;font-size: 85%;">
                    <li>
                        Methods running the database query
                        <ul>
                            <li><code>get()</code> returns a collection of all matching rows (as you already know)</li>
                            <li><code>first()</code> returns a single row
                                <pre class="bigger"><code class="hljs php">$user = DB::table('users')-&gt;where('name', 'John')-&gt;first();
echo $user-&gt;name;</code></pre>
                            </li>
                            <li><code>find()</code> retrieves a single row by the specified value for the <code>id</code> column
                                <pre class="bigger"><code class="hljs php">$user = DB::table('users')-&gt;find(3);</code></pre>
                            </li>
                            <li><code>value()</code> returns a single value
                                <pre class="bigger"><code class="hljs php">$email = DB::table('users')-&gt;where('name', 'John')-&gt;value('email');</code></pre>
                            </li>
                            <li><code>pluck()</code> returns a <strong>Collection</strong> of custom keys and <strong>values</strong>
                                <pre class="bigger"><code class="hljs php">$events = DB::table('event')-&gt;pluck('name', 'id');

foreach ($events as $id =&gt; $name) {
	&hellip;</code></pre>
                            </li>

                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Query Builder (4)</h2>

                <ul style="width: 100%;">
                    <li>
                        Chain a multitude of QB methods (<a href="https://laravel.com/docs/8.x/queries">docs</a>)
                        <ul>
                            <li>aggregate methods e.g. <code>count()</code>, <code>max()</code></li>
                            <li>much more e.g. <code>whereIn()</code>, <code>orWhere()</code>, joins e.g. <code>leftJoin()</code>, <code>on()</code> </li>
                            <li>Examples with <code>insert()</code>, <code>update()</code> and <code>delete()</code>
                                <pre class="bigger"><code class="hljs php">$id = DB::table('users')->insertGetId(
    ['email' => 'john@example.com', 'votes' => 0]
);

DB::table('users')
            ->where('id', 1)
            ->update(['votes' => 1]);

DB::table('users')->increment('votes', 5);

DB::table('users')->where('votes', '&lt;', 100)->delete();

DB::table('flights')-&gt;upsert([
    ['departure' =&gt; 'Oakland', 'destination' =&gt; 'San Diego', 'price' =&gt; 99],
    ['departure' =&gt; 'Chicago', 'destination' =&gt; 'New York', 'price' =&gt; 150]
], ['departure', 'destination'], ['price']);
</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>
        </section>

        <section>
            <section>
                <h2>02.4<br>Eloquent ORM</h2>
            </section>

            <section>
                <h2>Defining the models (1)</h2>

                <ul>
                    <li>
                        ORM: each database table has a corresponding "Model" which is used to interact with it (<a
                        href="https://laravel.com/docs/8.x/eloquent">Eloquent docs</a>)
                    </li>
                    <li>
                        First step: generate the models with Artisan <span class="warning">(! uppercase)</span>
                        <pre class="bigger"><code class="hljs bash">$ php artisan make:model Event</code></pre>
                        <ul>
                            <li>It generates the (pretty empty) class <code>Event</code> extending <code>Illuminate\Database\Eloquent\Model</code> in the <code>app/Models/</code> directory</li>
                            <li>By now, the model assumes that there is a table <code>events</code> <span class="warning">(! lowercase &amp; eng. plural)</span> in the database
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Defining the models (2)</h2>

                <ul style="width: 80%;">
                    <li>
                        <code>app/Models/Event.php</code>
                        <pre class="bigger"><code class="hljs php">&lt;?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Event extends Model
{
    //
}</code></pre>
                    </li>

                </ul>
                <footer><small>Actually, it imports the <code>HasFactory</code> trait as well, just leave it there.</small></footer>
            </section>

            <section>
                <h2>Defining the models (3)</h2>

                <ul>
                    <li>
                        Next step: mark <em>unexpected table characteristics</em> in your model
                        <ul>
                            <li>The model assumes that there is a table <code>events</code> (plural!) in the database, unless you add
                                <pre class="bigger"><code class="hljs php">protected $table = 'my_other_table_name';</code></pre>
                            </li>
                            <li>The model assumes the table has an (auto-increment) (integer) primary key called <code>id</code>, unless you add
                                <pre class="bigger"><code class="hljs php">protected $primaryKey = 'event_id';
public $incrementing = false;
protected $keyType = 'string';</code></pre>
                            </li>

                        </ul>
                    </li>
                </ul>

            </section>

            <section>
                <h2>Defining the models (4)</h2>

                <ul>
                    <li>
                        Next step: mark <em>unexpected table characteristics</em> in your model
                        <ul>
                            <li>The model assumes that the table has <code>created_at</code> and <code>updated_at</code> columns, unless you add
                                <pre class="bigger"><code class="hljs php">public $timestamps = false;</code></pre>
                                <ul>
                                    <li>Eloquent will automatically update these columns when creating/changing data</li>
                                    <li>Raw SQL Queries won't</li>
                                </ul>
                            </li>
                            <li>You don't need to add any information on the columns, but you can specify default values if you want
                                <pre class="bigger"><code class="hljs php">protected $attributes = [
   'delayed' => false,
];</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
                <footer><small>Note: there are also settings on timestamp column names and formats</small></footer>
            </section>

            <section>
                <h2>Retrieving data</h2>

                <ul>
                    <li>
                        From now on, you can filter/select/aggregate data using the model
                        <ul>
                            <li>Eloquent's <code>all()</code> returns all records in the table
                                <pre class="bigger"><code class="hljs php">use App\Models\Event;

foreach (Event::all() as $event) {
    echo $event-&gt;name;
}</code></pre>
                            </li>
                            <li>Rely on Query Builder for many other (chained) methods
                                <pre class="bigger"><code class="hljs php">$events = Event::where('active', 1)
           -&gt;orderBy('name', 'desc')
           -&gt;take(10)
           -&gt;get();</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Find or fail</h2>

                <ul style="width: 100%;">
                    <li>
                        Retrieving single records with Eloquent's <code>find()</code> and <code>first()</code>
                        <pre class="bigger"><code class="hljs php">use App\Models\Event;

$event15 = Event::find(15); // retrieval by primary key
$activeEvent = Event::where('active', 1)->first(); // retrieve the first record
$activeEvent = Event::firstWhere('active', 1); // same</code></pre>
                        <ul>
                            <li>Throw a <code>ModelNotFoundException</code> when no result is found:
                                <pre class="bigger"><code class="hljs php">$event15 = Event::findOrFail(15);
$activeEvent = Event::where('active', 1)->firstOrFail();</code></pre>
                            </li>
                            <li>Results in a <code>404</code> HTTP response when not caught (!)</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Active record</h2>

                <ul>
                    <li>
                        You can insert, update and delete rows correspondingly to the <a href="https://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>
                        <pre class="bigger"><code class="hljs php">use App\Models\Event;

$event = new Event;
$event-&gt;name = $request->name;
$event-&gt;save();

$event = Event::find(1);
$event-&gt;name = 'Pukkelpop 2021';
$event-&gt;save();

$event-&gt;delete();
</code></pre>
                        <ul>
                            <li>Note: alternately, you can do the same stuff with Event's static methods in the next slides &hellip; - by the way Eloquent also enables deletion by PK:

                            </li>
                        </ul>
                        <pre class="bigger"><code class="hljs php">Event::destroy(7);</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Mass-assignment vulnerability (1)</h2>

                <ul>
                    <li>
                        Mass assignment
                        <ul style="font-size: 90%;">
                            <li>Definition: use a method to save a new model in a single line
                                <pre class="bigger"><code class="hljs php">$user = User::create(['name' =&gt; 'Franky Pallemans', 'company' =&gt; 'Cynalco']);</code></pre>
                            </li>
                            <li>It enables to pass all parameter/value-pairs of the HTTP request's querystring to the create method (think of &hellip; a registration form)
                                <pre class="bigger"><code class="hljs php">$user = User::create($request-&gt;all());</code></pre>
                            </li>
                            <li><strong>Mass-assignment vulnerability</strong>: a malicious user adds a parameter to the HTTP request e.g. <code>role=administrator</code> which is passed to the create method
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Mass-assignment vulnerability (2)</h2>

                <ul>
                    <li>
                        Mass assignment vulnerability protection
                        <ul>
                            <li>It is required to
                                <ul>
                                    <li>blacklist: <code>protected $guarded = ['role'];</code>
                                    </li>
                                    <li>or whitelist: <code>protected $fillable = ['name', 'company'];</code> &rarr; <strong>our choice</strong>
                                    </li>
                                </ul>
                                the mass assignable attributes in the model class
                            </li>

                            <li>Attention: when you pass a blacklisted/not-whitelisted parameter to the create method
                                <ul>
                                    <li>You don't get an error
                                    </li>
                                    <li>Laravel just drops that parameter</code>
                                    </li>
                                </ul>
                            </li>
                            <li>It only applies to vulnerable methods so you can still
                                <pre class="bigger"><code class="hljs php">$user-&gt;role = 'administrator';
$user-&gt;save();</code></pre>
                            </li>

                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>More mass-assignment methods</h2>

                <ul style="width: 100%;">
                    <li>
                        Apply <code>fill()</code> on a model instance
                        <pre class="bigger"><code class="hljs php">use App\Models\Event;

$event = new Event;
$event-&gt;fill(['name' => 'Pukkelpop 2021']);</code></pre>
                    </li>
                    <li>
                        Conditional creation
                        <pre class="bigger"><code class="hljs php">// Retrieve the event by the attributes, or create it if it doesn't exist...
$event = Event::firstOrCreate(['name' => 'Dranouter 2021']);

// Retrieve the event by the attributes, or instantiate a new instance...
$event = Event::firstOrNew(['name' => 'Dranouter 2021']);
$event-&gt;save();

// If there's a matching event, set the price to $99.
// If no matching event exists, create one.
$event = Event::updateOrCreate(['name' => 'Dranouter 2021'], ['price' => 99]);

// Same for multiple rows? use Event::upsert()</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Eloquent relationships (1)</h2>

                <ul>
                    <li>
                        One-to-many example
                        <ul>
                            <li>Suppose a 1:n relation between <em>users</em> and <em>tasks</em> &rarr; table <em>tasks</em> has a foreign key column <code>user_id</code>
                            </li>
                            <li>Instead of working with FKs in Laravel, you want to interact with the related objects directly
                                <pre class="bigger"><code class="hljs php">$user = User::find(1);

foreach ($user-&gt;tasks as $task) {
    echo $task-&gt;name;
}
</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Eloquent relationships (2)</h2>

                <ul>
                    <li>
                        Bidirection support 1:n
                        <ul>

                            <li>Add to the <code>User</code> class: <span class="warning">(! plural)</span>
                                <pre class="bigger"><code class="hljs php">public function tasks()
{
        return $this-&gt;hasMany(Task::class);
}
</code></pre>
                            </li>

                            <li>Add to the <code>Task</code> class: <span class="warning">(! singular)</span>
                                <pre class="bigger"><code class="hljs php">public function user()
{
        return $this-&gt;belongsTo(User::class);
}
</code></pre>
                            </li>

                            <li>Read the <a href="https://laravel.com/docs/8.x/eloquent-relationships">docs on Eloquent relationships</a> to learn about other types of relationships
                            </li>
                        </ul>
                    </li>
                </ul>
                <footer><small><code>hasMany</code> and <code>belongsTo</code> have further options for non-default column names</small></footer>
            </section>

            <section>
                <h2>Eloquent relationships (3)</h2>

                <ul style="font-size: 85%;">
                    <li>
                        Interesting facts
                        <ul>

                            <li>In the previous example
                                <pre class="bigger"><code class="hljs php">$user-&gt;tasks</code></pre>
                                returns a collection of task objects (data)
                            </li>
                            <li>Actually, what you didn't know: Eloquent return a special sort of collection: an <a
                                href="https://laravel.com/docs/8.x/eloquent-collections">Eloquent Collection</a> &rarr; <em>keep on chaining</em>
                            </li>
                            <li>In the previous example
                                <pre class="bigger"><code class="hljs php">$user-&gt;tasks()</code></pre>
                                returns a query builder object &rarr; <em>keep on chaining</em>
                            </li>

                            <li style="margin-top: 1em;">
                                <strong>Many-to-many relationships</strong>: before you start:
                                <br>
                                <span class="warning">never</span> make a separate model for the intermediate (= pivot) table

                            </li>


                        </ul>
                    </li>
                </ul>

            </section>

            <section>
                <h2>Eloquent with dates and times</h2>

                <ul style="font-size: 85%;">
                    <li>
                        As you know, Laravel comes with <a href="http://carbon.nesbot.com/docs/">Carbon</a><pre class="bigger"><code class="hljs php">use Carbon\Carbon;</code></pre>
                        <ul>
                            <li>The Carbon class extends the PHP <a href="http://www.php.net/manual/en/class.datetime.php">DateTime</a> class
                            </li>
                            <li>You can use it as part of a query
                                <pre class="bigger"><code class="hljs php">$events = Event::where('event_date', '<', new Carbon('yesterday 23:10'))-&gt;get();
</code></pre>
                            </li>
                            <li>In order to have a Carbon object auto-casted at any time in Eloquent, you need to tell Eloquent first
                                <pre class="bigger"><code class="hljs php">class Event extends Model
{
    protected $casts = [
        'event_date' => 'datetime:Y-m-d',
        // you don't need to mention created_at and updated_at here!
    ];
}
</code></pre>
                            </li>
                            <li>Now you can do things like <code>$event-&gt;event_date = Carbon::now();</code></li>
                            <li>Actually, with <code>$casts</code> you can define <a href="https://laravel.com/docs/8.x/eloquent-mutators#attribute-casting">many cast types</a> in order to have your attributes auto-converted</li>
                        </ul>
                    </li>
                </ul>
            </section>
        </section>

        <section>
            <section>
                <h2>02.5<br>Intermezzo: Migrations</h2>
            </section>

            <section>
                <h2>Migrations (1)</h2>

                <ul>
                    <li>
                        Typical dev team situation
                        <ul>
                            <li>All team members have a local (test) instance of the database </li>
                            <li>From time to time the DB schema is modified</li>
                            <li>How can we easily share these changes?
                                <ul>
                                    <li>By changing the global SQL-dump and put it to version control? Maybe, but it doesn't scale </li>
                                    <li>By adding an SQL-update file and put it to version control? Maybe, but it is difficult to produce and it is not structured</li>
                                </ul></li>
                        </ul>
                    </li>
                    <li>
                        Solution: Database Migrations
                        <ul>
                            <li>Easily modify and share the application's database schema. </li>
                            <li>It's like version control for your DB</li>

                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Migrations (2)</h2>

                <ul>
                    <li>
                        How does it work?
                        <ul>
                            <li>A modification to the DB schema is described in a migration class file, named with a timestamp, located in <code>database/migrations</code> </li>
                            <li>A migration class contains two methods: <code>up</code> (perform migration) and <code>down</code> (reverse).</li>
                            <li>These modification are programmed with Laravel schema builder </li>
                            <li style="margin-top: 1em">Artisan helps you to create blueprints of migration classes </li>
                            <li>Put successful migrations to version control </li>
                            <li>In one Artisan command, you can execute all migrations that have not been executed before (logged in the DB table <code>migrations</code>)</li>
                        </ul>
                    </li>

                    <li>
                        Read more about it in the <a href="https://laravel.com/docs/8.x/migrations">Laravel docs on Migrations</a>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Migrations (3)</h2>

                <ul style="font-size: 85%; width: 100%;">
                    <li>
                        Example: table creation
                        <pre class="bigger"><code class="hljs bash">$ php artisan make:migration create_events_table --create=events</code></pre>
                        <ul>
                            <li>generates <code>database/migrations/&lt;timestamp&gt;_create_events_table.php</code>
                                <pre class="bigger"><code class="hljs php">class CreateEventsTable extends Migration
{
    public function up()
    {
        Schema::create('events', function (Blueprint $table) {
            $table-&gt;id(); // your table has a PK auto-inc unsigned bigint column id
            $table-&gt;timestamps(); // your table has created_at and updated_at columns
        });
    }

    public function down()
    {
        Schema::drop('events');
    }
}</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
                <footer><small>Note: if you create the classes without Artisan you need to call <code>composer dump-autoload</code></small></footer>
            </section>

            <section>
                <h2>Migrations (4)</h2>

                <ul style="width: 100%;">
                    <li>
                        Example: table creation
                        <ul>
                            <li>complete the schema creation
                                <pre class="bigger"><code class="hljs php">public function up()
{
	Schema::create('events', function (Blueprint $table) {
		$table-&gt;id(); // LEAVE IT HERE
		$table-&gt;string('title');
		$table-&gt;text('description');
		$table-&gt;date('event_date');

		// foreign key: column types need to be EXACTLY the same
		$table-&gt;unsignedBigInteger('location_id');
		$table-&gt;foreign('location_id')-&gt;references('id')-&gt;on('locations');
		// all at once: $table->foreignId('location_id')->constrained();

		$table-&gt;timestamps(); // LEAVE IT HERE
	});
}</code></pre>
                            </li>
                            <li>run all migrations
                                <pre class="bigger"><code class="hljs bash">$ php artisan migrate</code></pre>
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Migrations (5)</h2>

                <ul>
                    <li>
                        Let's get practical
                        <ul>
                            <li>
                                Consult the tables in the <a href="https://laravel.com/docs/8.x/migrations#creating-columns">migrations docs</a> on available column types, column modifiers and index modifiers
                            </li>
                            <li>After all, there exists a <em>mapping</em> for each command, data type, &hellip; to each of the supported DBMS systems</li>
                            <li>More flavours of <code>php artisan migrate</code>
                                <pre class="bigger"><code class="hljs bash">  migrate:fresh     Drop all tables and re-run all migrations
  migrate:install   Create the migration repository
  migrate:refresh   Reset and re-run all migrations
  migrate:reset     Rollback all database migrations
  migrate:rollback  Rollback the last database migration
  migrate:status    Show the status of each migration
</code></pre>
                            </li>
                            <li>Still stuck? Delete the <code>migrations</code> table
                            </li>
                        </ul>
                    </li>
                </ul>
            </section>

            <!--section>
                <h2>Migrations bug with MySQL utf8mb4</h2>

                <ul>
                    <li style="font-size: 80%">
                        The <a href="http://aoverton.com/web-development/using-mysql-utf8mb4-with-laravel-5/">problem</a>
                        <ul>
                            <li>Definition of string columns with Migrations<pre class="bigger"><code class="hljs php">$table-&gt;string('name');
$table-&gt;string('email')-&gt;unique();
</code></pre></li>
                            <li>Default string length in Laravel's Schema Builder: 255 chars</li>
                            <li>With utf8mb4: 255 * 4 = 1020 bytes</li>
                            <li>Max length: 1000 bytes for MyISAM, 767 bytes for InnoDB<pre><code class="hljs bash">[Illuminate\Database\QueryException] SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key
was too long; max key length is 767 bytes (SQL: alter table `users` add unique users_email_unique(`email`))
</code></pre></li>

                        </ul>
                    </li>
                    <li style="font-size: 80%">
                        Solutions
                        <ul>
                            <li>Best: correct string lengths<pre class="bigger"><code class="hljs php">$table-&gt;string('name', 191);
$table-&gt;string('email', 191)-&gt;unique();
</code></pre></li>
                            <li>Good: just use <em>utf8</em> (= 3-byte-encoding) for your DB</li>
                            <li>
                                Bad: replace <em>utf8mb4</em> by <em>utf8</em> in <code>config/database.php</code>
                                &rarr; you're fooling the system
                            </li>
                        </ul>
                    </li>

                </ul>
            </section-->



        </section>


        <section>
            <section>
                <h2>02.6<br>MVC recap</h2>
            </section>

            <section>
                <h2>MVC in Laravel: overview</h2>
                <p><img src="assets/02/mvc_diagram_with_routes.png" alt="" title="" width="600" style="background-color:white;" />
                <div style="font-size: 50%; line-height: 100%;margin-top: -1em;">
                    Source: <a href="https://selftaughtcoders.com/from-idea-to-launch/lesson-17/laravel-5-mvc-application-in-10-minutes/">selftaughtcoders.com</a></span>
                </div>
            </section>

            <section>
                <h2>MVC in Laravel: overview</h2>
                <ul>
                    <li><strong>Models</strong>: generate Eloquent models with Artisan</li>
                    <li style="margin-top: 1em;"><strong>Views</strong>: store your Blade (or PHP) templates in <code>resources/views</code> </li>
                    <li style="margin-top: 1em;"><strong>Controllers</strong>: see next slide(s)</li>
                </ul>
            </section>
        </section>

        <section>
            <section data-background="https://i.makeagif.com/media/3-11-2016/SU3i02.gif">
                <h2>02.7<br>HTTP Controllers</h2>
                <p>This is the sound of C &hellip;</p>
            </section>

            <section>
                <h2>HTTP Controllers (1)</h2>

                <ul style="font-size: 80%; width: 70%;">
                    <li>Create a <code>*Controller</code> in the folder <code>app/Http/Controllers</code>
                        <pre class="bigger"><code class="hljs bash">php artisan make:controller TaskController</code></pre>
                    </li>
                    <li>
                        Point to its <strong>methods</strong> in <code>/routes/web.php</code>
                        <pre class="bigger"><code class="hljs php">use App\Http\Controllers\TaskController;

Route::get('/tasks', [TaskController::class, 'index']);
Route::post('/tasks/create', [TaskController::class, 'store']);
Route::post('/tasks/{task}/delete', [TaskController::class, 'destroy']);</code></pre>
                    </li>
                    <li>
                        Write the appropriate method(s) in <code>*Controller</code>
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    public function index(Request $request)
    {
        $tasks = Task::where('user_id', $request-&gt;input('user_id'))
                    -&gt;orderBy('created_at', 'asc')
                    -&gt;get();
        return view('tasks.index', ['tasks' =&gt; $tasks]);
    }

    public function destroy(Request $request, $id) </code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>HTTP Controllers (2)</h2>

                <ul style="font-size: 80%; width: 80%;">
                    <li>
                        Only include the (type-hinted) $request parameter when needed
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    public function index()
    {
        return view('tasks.index');
    }</code></pre>
                    </li>
                    <li>
                        <a href="https://laravel.com/docs/8.x/routing#route-model-binding">Implicit model binding:</a> Eloquent will use the <code>id</code> column
                        <pre class="bigger"><code class="hljs php">Route::post('/tasks/{task}/delete', [TaskController::class, 'destroy']);</code></pre>
                        <pre class="bigger"><code class="hljs php">class TaskController extends Controller
{
    &hellip;
    public function destroy(Task $task) // implicit model binding (on ID) + 404 on fail
    {
        $task-&gt;delete();
        return redirect('/tasks');
    }</code></pre>
                    </li>
                </ul>
                <footer><small>Override the model's <code>getRouteKeyName()</code> in order to use another column for this</small></footer>

            </section>

            <section>
                <h2>Generating all classes together</h2>

                <ul style="width: 100%;">
                    <li>
                        Typical flow
                        <pre class="bigger"><code class="hljs bash"># start from an empty DB

# creates  model + create_products_table migration + ProductSeeder + ProductController
$ php artisan make:model Product -msc

# migration contains: $table-&gt;id();
# migration contains: $table-&gt;timestamps();
# add to your migration: other columns

$ php artisan migrate

# add data to your seeder

$ php artisan db:seed --class=ProductSeeder

# add to your model: mass-assignable blacklist/whitelist and dates/times

# use App\Models\Product wherever you want for your DB operations from your ProductController</code></pre>
                    </li>

                </ul>
                <footer><small>Note: Laravel comes with a pre-installed (extensible) migration and model for a <code>users</code> table </small></footer>
            </section>

            <!--section>
                <h2>Repositories (1)</h2>

                <ul>
                    <li>Repositories in Laravel
                        <ul>
                            <li style="margin-top: 1em;">Only useful for complex queries you'd call from multiple locations in your code (cf. code reuse)</li>
                        </ul>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Repositories (2)</h2>

                <ul>
                    <li>Create the <code>app/Repositories</code> directory and add a <code>*Repository</code> class yourself
                        <pre class="bigger"><code class="hljs php">&lt;?php
namespace App\Repositories; // there is PSR-4 autoloading ...

use App\Task;

class TaskRepository
{
    public function forUserId($id)
    {
        return Task::where('user_id', $id)
                    -&gt;orderBy('created_at', 'asc')
                    -&gt;get();
    }
	&hellip;
}</code></pre>
                    </li>
                </ul>
            </section>

            <section>
                <h2>Repositories (3)</h2>

                <ul>
                    <li>
                        Inject the repository in the corresponding <code>*Controller</code>
                        <pre class="bigger"><code class="hljs php">namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Repositories\TaskRepository;

class TaskController extends Controller
{
    protected $tasks;

    public function __construct(TaskRepository $tasks)
    {
        $this-&gt;tasks = $tasks;
    }

    public function index(Request $request)
    {
        return view('tasks.index', [
            'tasks' =&gt; $this-&gt;tasks-&gt;forUserId($request-&gt;input('user_id'))
        ]);
    }
	&hellip;
}</code></pre>
                    </li>
                </ul>
            </section-->



        </section>

        <!-- The END -->
        <section>
            <section>
                <h2>Questions?</h2>
                <footer>
                    <em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:joris.maervoet@odisee.be">joris.maervoet@odisee.be</a></em>
                </footer>
            </section>

            <section>
                <h2>Sources</h2>


                <ul>
                    <li><a href="https://laravel.com/docs/8.x/queries">Laravel docs: Database: Query Builder</a></li>
                    <li><a href="https://laravel.com/docs/8.x/eloquent">Laravel docs: Eloquent: Getting Started</a></li>
                    <li><a href="https://laravel.com/docs/8.x/migrations">Laravel docs: Migrations</a></li>


                    <li><a href="https://laravel.com/docs/8.x/controllers">Laravel docs: Controllers</a></li>
                    <li><a href="https://laravel.com/docs/8.x/routing#route-model-binding">Laravel docs: Route Model Binding</a></li>

                </ul>
            </section>
        </section>


    </div>

</div>

<script src="dist/reveal.js"></script>
<script src="plugin/zoom/zoom.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/search/search.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>

    // Also available as an ES module, see:
    // https://revealjs.com/initialization/
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        slideNumber: true,


        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
    });

</script>
<script src="toc.js"></script>
<script src="overlay.js"></script>

</body>
</html>
